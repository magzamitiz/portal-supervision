<!DOCTYPE html>
<!--
    PORTAL DE SUPERVISI√ìN V2.0
    Sistema optimizado sin gr√°ficos para m√°ximo rendimiento
    
    Caracter√≠sticas implementadas:
    - Sistema de cach√© optimizado con compresi√≥n
    - Estad√≠sticas r√°pidas desde _ResumenDashboard
    - Mapeo autom√°tico de almas con diagn√≥stico
    - Fragmentaci√≥n de cach√© estable (50KB fragmentos)
    - Interfaz limpia y r√°pida sin dependencias de gr√°ficos
    
    √öltima actualizaci√≥n: Diciembre 2024
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Supervisi√≥n V2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilos V2.0 (Usando kebab-case est√°ndar) */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ‚úÖ NUEVO: Estilos para perfiles de l√≠deres basados en IDP */
        .status-estratega { background: #10b981; color: #ffffff; font-weight: 600; } /* üöÄ Verde oscuro */
        .status-conector { background: #86efac; color: #065f46; font-weight: 600; } /* üéØ Verde claro */
        .status-activador { background: #fef3c7; color: #92400e; font-weight: 600; } /* ‚ö° Amarillo */
        .status-desarrollo { background: #e5e7eb; color: #6b7280; font-weight: 600; } /* üå± Gris */
        
        /* Compatibilidad con c√≥digo antiguo */
        .status-activo { background: #10b981; color: #ffffff; }
        .status-alerta { background: #fef3c7; color: #92400e; }
        .status-inactivo { background: #e5e7eb; color: #6b7280; }
        .status-sindatos { background: #e5e7eb; color: #6b7280; }

        .carga-optima { background: #d1fae5; color: #065f46; }
        .carga-moderada { background: #dbeafe; color: #1e40af; }
        .carga-alta { background: #fed7aa; color: #92400e; }
        .carga-sobrecargado { background: #fee2e2; color: #991b1b; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media print {
            .no-print { display: none !important; }
            #modalContenido { max-height: none !important; overflow: visible !important; }
        }
        
        
        
        /* Asegurar que los contenedores no se desborden */
        .bg-white.rounded-lg.shadow-md {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <div id="loader" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">Cargando portal de supervisi√≥n V2.0...</p>
            <p class="text-xs text-gray-400 mt-2" id="loaderStatus">Verificando datos...</p>
        </div>
    </div>
    
    <header class="gradient-bg text-white shadow-lg no-print sticky top-0 z-40">
        <div class="container mx-auto px-4 py-5">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <i class="fas fa-users-cog"></i>
                        Portal de Supervisi√≥n V2.0
                    </h1>
                    <p class="text-purple-200 mt-1">Sistema Integral de Seguimiento</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="text-right text-xs text-purple-200 mr-4 hidden md:block">
                        <p>Datos generados:</p>
                        <p id="dataTimestamp" class="font-semibold">Cargando...</p>
                    </div>

                    <button onclick="irAHome()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition" title="Volver al inicio del dashboard">
                        <i class="fas fa-home"></i> Home
                    </button>
                    <button onclick="recargarDatos()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition" title="Forzar actualizaci√≥n desde Google Sheets (Ignorar cach√©)">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <button onclick="verManual()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition" title="Manual de uso">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <div id="errorConfig" class="container mx-auto px-4 mt-4 hidden">
        <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle mr-3 mt-1"></i>
                <div>
                    <p class="font-semibold">Error del Sistema</p>
                    <p class="text-sm mt-1" id="errorMessage">Ocurri√≥ un error al cargar los datos.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido para mejorar rendimiento -->
    
    <main class="container mx-auto px-4 py-8">
        
        <div id="estadisticasGenerales" class="mb-8">
            </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-user-tie text-purple-600 mr-2"></i>
                    Supervisi√≥n de Equipo (LD)
                </h2>
                <div id="accionesLD" class="hidden gap-2">
                     <button id="btnGenerarReporte" onclick="generarReporteLD()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-file-pdf"></i> Generar Reporte
                    </button>
                </div>
            </div>
            <select id="ldSelector" onchange="cargarDatosLD()" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">-- Selecciona un L√≠der de Disc√≠pulos --</option>
            </select>
        </div>
        
        <div id="resumenLD" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            </div>
        
        
        <!-- ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido para mejorar rendimiento -->
        
        <div id="panelLCFs" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-home text-purple-600 mr-2"></i>
                Equipo de L√≠deres de Casa de Fe (LCF)
            </h2>
            
            <div id="gridLCFs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>
    </main>
    
    <div id="modalLCF" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h3 id="modalTitulo" class="text-xl font-bold"></h3>
                    <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700 no-print">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="modalContenido" class="p-6">
                    </div>
                <div class="border-t px-6 py-4 flex justify-end gap-3 no-print">
                    <button onclick="imprimirDetalles()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button onclick="cerrarModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>

// Variable global para controlar navegaciones
window.navegacionEnCurso = false;

// Variable global para el LD seleccionado
let ldSeleccionado = null;

// Variable global para los datos actuales del dashboard
let datosActuales = null;

function navegarDesdeModalA(funcionDestino, ...parametros) {
    // Evitar m√∫ltiples navegaciones simult√°neas
    if (window.navegacionEnCurso) {
        console.log('Navegaci√≥n en curso, ignorando nueva solicitud');
        return;
    }
    
    window.navegacionEnCurso = true;
    console.log(`Navegando a: ${funcionDestino} con params:`, parametros);
    
    // Cerrar modal actual
    const modal = document.getElementById('modalLCF');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
    
    // Ejecutar con delay controlado
    setTimeout(() => {
        try {
            if (typeof window[funcionDestino] === 'function') {
                window[funcionDestino](...parametros);
            } else {
                console.error(`Funci√≥n ${funcionDestino} no encontrada`);
                Swal.fire('Error', `Funci√≥n ${funcionDestino} no disponible`, 'error');
            }
        } catch (error) {
            console.error(`Error ejecutando ${funcionDestino}:`, error);
            Swal.fire('Error', `Error al ejecutar ${funcionDestino}`, 'error');
        } finally {
            window.navegacionEnCurso = false;
        }
    }, 500); // Aumentar a 500ms para mayor estabilidad
}
        
        // NUEVA FUNCI√ìN DE UTILIDAD: Sanitiza texto para HTML (Evita errores por caracteres especiales)
    // ==================== FUNCIONES DE SANITIZACI√ìN MEJORADAS ====================
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            // Convertir a string de forma segura
            const text = String(str);
            if (!text) return '';
            
            // Escape completo incluyendo / para evitar cierre de tags
            return text.replace(/[&<>"'\/]/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;',  // Usar c√≥digo num√©rico para mejor compatibilidad
                    '/': '&#x2F;'   // Prevenir cierre de script tags
                }[m];
            });
        }

        // Nueva funci√≥n para escapar atributos de forma segura
        function escapeAttr(str) {
            if (str === null || str === undefined) return '';
            const text = String(str);
            if (!text) return '';
            
            // Escape m√°s estricto para atributos
            return text
                .replace(/&/g, '&amp;')
                .replace(/'/g, '&#x27;')
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\//g, '&#x2F;')
                .replace(/=/g, '&#x3D;')
                .replace(/`/g, '&#x60;');  // Tambi√©n escapar backticks
        }
        // ==================== FIN FUNCIONES DE SANITIZACI√ìN ====================

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
          cargarDatosIniciales();
      });

        // ==================== HELPERS V2.0 ====================
        
        // Helper para obtener el color del estado (V2.0)
        function getEstadoColor(estado) {
            // ‚úÖ NUEVO: Usar perfiles de l√≠deres basados en IDP
            if (estado && estado.includes('ESTRATEGA')) return 'status-estratega';
            if (estado && estado.includes('CONECTOR')) return 'status-conector';
            if (estado && estado.includes('ACTIVADOR')) return 'status-activador';
            if (estado && estado.includes('DESARROLLO')) return 'status-desarrollo';
            
            // Fallback para compatibilidad con c√≥digo antiguo
            switch (estado) {
                case 'Activo': return 'status-estratega';
                case 'Alerta': return 'status-activador';
                case 'Inactivo': return 'status-desarrollo';
                case 'Sin Datos': return 'status-desarrollo';
                default: return 'status-desarrollo';
            }
        }

        // Helper para obtener el color de la carga
        function getCargaColor(carga) {
             switch (carga) {
                case 'Baja': return 'carga-optima';        // Verde (10-15 almas)
                case 'Media': return 'carga-moderada';     // Azul (16-25 almas)
                case 'Alta': return 'carga-alta';          // Naranja (26-35 almas)
                case 'Muy Alta': return 'carga-sobrecargado'; // Rojo (36+ almas)
                case '√ìptima': return 'carga-optima';      // Legacy
                case 'Moderada': return 'carga-moderada';  // Legacy
                case 'SOBRECARGADO': return 'carga-sobrecargado';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        
        // ==================== CARGA DE DATOS ====================

        // Funciones de control del loader
        function mostrarLoader() {
            document.getElementById('loader').style.display = 'flex';
        }
        
        function ocultarLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // Cargar datos iniciales (Usa cach√© si est√° disponible)
function cargarDatosIniciales() {
    console.log('üöÄ [OPTIMIZADO] Iniciando carga paralela optimizada...');
    const startTime = Date.now();
    
    // Mostrar loader con mensaje espec√≠fico
    document.getElementById('loaderStatus').textContent = 'Ejecutando llamadas paralelas optimizadas...';
    mostrarLoader();
    
    // Llamadas paralelas para m√°xima velocidad usando funciones optimizadas
    Promise.allSettled([
        // Llamada 1: Estad√≠sticas r√°pidas optimizadas
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getEstadisticasRapidas();
        }),
        
        // Llamada 2: Lista de l√≠deres optimizada
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getListaDeLideres();
        }),
        
        // Llamada 3: Dashboard completo optimizado
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getDashboardData();
        })
    ]).then(results => {
        console.log('‚úÖ Llamadas paralelas completadas en:', Date.now() - startTime, 'ms');
        
        // Procesar resultados
        const [statsResult, lideresResult, dashboardResult] = results;
        
        // Procesar estad√≠sticas - ‚úÖ VALIDACI√ìN ROBUSTA
        if (statsResult.status === 'fulfilled' && statsResult.value?.success) {
            handleEstadisticasResponse(statsResult.value);
        } else {
            const errorMsg = statsResult.value?.error || statsResult.reason || 'Respuesta nula del servidor';
            console.error('‚ùå Error en estad√≠sticas:', errorMsg);
        }
        
        // Procesar l√≠deres - ‚úÖ VALIDACI√ìN ROBUSTA
        if (lideresResult.status === 'fulfilled' && lideresResult.value?.success) {
            handleLideresResponse(lideresResult.value);
        } else {
            const errorMsg = lideresResult.value?.error || lideresResult.reason || 'Respuesta nula del servidor';
            console.error('‚ùå Error en l√≠deres:', errorMsg);
        }
        
        // Procesar dashboard - ‚úÖ VALIDACI√ìN ROBUSTA
        if (dashboardResult.status === 'fulfilled' && dashboardResult.value?.success) {
            handleDatosCompletosResponse(dashboardResult.value);
        } else {
            const errorMsg = dashboardResult.value?.error || dashboardResult.reason || 'Respuesta nula del servidor';
            console.error('‚ùå Error en dashboard:', errorMsg);
        }
        
        // Actualizar timestamp
        document.getElementById('dataTimestamp').textContent = new Date().toLocaleString();
        
        console.log('‚úÖ Dashboard cargado completamente en:', Date.now() - startTime, 'ms');
        ocultarLoader();
        
    }).catch(error => {
        console.error('‚ùå Error cr√≠tico en llamadas paralelas:', error);
        handleDataFailure(error);
        ocultarLoader();
    });
}

// Nueva funci√≥n para manejar la respuesta de las estad√≠sticas
function handleEstadisticasResponse(response) {
    if (response && response.success) {
        console.log('üìä Estad√≠sticas r√°pidas recibidas');
        
        // ‚úÖ CORRECCI√ìN: Guardar estad√≠sticas para reutilizar en actualizarInterfaz
        ultimasEstadisticas = response.data;
        
        actualizarEstadisticas(response.data); // Funci√≥n que dibuja los cuadros de resumen
        
        // Actualizar timestamp si existe
        const timestampElement = document.getElementById('dataTimestamp');
        if (timestampElement && response.data.timestamp) {
            timestampElement.textContent = new Date(response.data.timestamp).toLocaleString();
        }
    } else {
        console.error('‚ùå Error en estad√≠sticas:', response ? response.error : "Respuesta inv√°lida");
        handleDataFailure(response ? response.error : "Respuesta de estad√≠sticas inv√°lida");
    }
    // No se esconde el loader aqu√≠, se espera a que ambas llamadas terminen o la principal
}

// Nueva funci√≥n para manejar la respuesta de datos completos con alertas
function handleDatosCompletosResponse(response) {
    if (response && response.success) {
        const modo = response.data.modo_carga || 'Desconocido';
        console.log(`üìä Datos completos recibidos - Modo: ${modo}`);
        console.log('Datos completos con alertas recibidos:', response.data);
        
        // Actualizar datosActuales con la informaci√≥n completa
        datosActuales = response.data;
        window.datosActuales = response.data;
        
        // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido
        
        // Ocultar el loader una vez que tenemos los datos completos
        document.getElementById('loader').style.display = 'none';
        
        console.log(`‚úÖ Dashboard cargado completamente con alertas - Modo: ${modo}`);
    } else {
        console.error('Error cargando datos completos:', response ? response.error : 'Error desconocido');
        // No fallar completamente, solo mostrar warning
        console.warn('Continuando sin alertas completas...');
    }
}

// Nueva funci√≥n para manejar errores de datos completos
function handleDatosCompletosError(error) {
    console.error("Error cargando datos completos:", error);
    
    // Ocultar loader
    document.getElementById('loader').style.display = 'none';
    
    // Mostrar mensaje de error amigable
    if (error && error.toString().includes('Excedi√≥ el tiempo m√°ximo de ejecuci√≥n')) {
        console.log('Timeout detectado, mostrando mensaje informativo...');
        
        // Mostrar alerta informativa sobre el timeout
        Swal.fire({
            title: '‚è±Ô∏è Carga Optimizada',
            html: `
                <p>El sistema est√° cargando datos de forma optimizada para evitar timeouts.</p>
                <p><strong>Datos disponibles:</strong></p>
                <ul style="text-align: left; margin: 10px 0;">
                    <li>‚úÖ Estad√≠sticas b√°sicas</li>
                    <li>‚úÖ Lista de l√≠deres</li>
                    <li>‚ö†Ô∏è Datos completos en proceso...</li>
                </ul>
                <p><small>Puedes usar el bot√≥n "Recargar" para intentar cargar datos completos.</small></p>
            `,
            icon: 'info',
            confirmButtonText: 'Entendido',
            allowOutsideClick: true,
            timer: 5000,
            timerProgressBar: true
        });
    } else {
        // Error gen√©rico
        Swal.fire({
            title: 'Error de Carga',
            text: 'Hubo un problema cargando los datos completos. Los datos b√°sicos est√°n disponibles.',
            icon: 'warning',
            confirmButtonText: 'Entendido'
        });
    }
}

// Funci√≥n para manejar la respuesta de recarga completa
function handleRecargaCompleta(response) {
    const modo = response.data?.modo_carga || 'Desconocido';
    console.log(`üîÑ Recarga completa exitosa - Modo: ${modo}`);
    console.log('Recarga completa exitosa:', response);
    
    if (response && response.success && response.data) {
        // Actualizar datosActuales con la informaci√≥n completa
        datosActuales = response.data;
        window.datosActuales = response.data;
        
        // ‚úÖ CORRECCI√ìN: Actualizar m√©tricas y timestamp despu√©s de recarga
        console.log('üîÑ Actualizando m√©tricas despu√©s de recarga...');
        
        // ‚úÖ CORRECCI√ìN: Usar estructura alineada {fila1, fila2, calculadas}
        const datosSeguros = {
            fila1: response.data.fila1 || {},
            fila2: response.data.fila2 || {},
            calculadas: response.data.calculadas || {},
            timestamp: response.data.timestamp || new Date().toISOString()
        };
        
        actualizarEstadisticas(datosSeguros);
        actualizarTimestamp();
        
        // ‚úÖ CORRECCI√ìN: Actualizar selector de LD con datos frescos
        if (response.data.lideres?.lista) {
            console.log('üîÑ Actualizando selector de LD con datos frescos...');
            const ldAnterior = ldSeleccionado; // Conservar selecci√≥n previa
            llenarSelectorLD(response.data.lideres.lista);
            
            // Restaurar selecci√≥n previa si el LD sigue existiendo
            if (ldAnterior && response.data.lideres.lista.some(ld => ld.ID_Lider === ldAnterior)) {
                ldSeleccionado = ldAnterior;
                const selector = document.getElementById('ldSelector');
                if (selector) {
                    selector.value = ldAnterior;
                    console.log(`‚úÖ Selecci√≥n de LD restaurada: ${ldAnterior}`);
                } else {
                    console.warn('‚ö†Ô∏è Selector ldSelector no encontrado en el DOM');
                }
            }
        }
        
        // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido
        
        // Cerrar el modal de carga
        if (Swal.isVisible()) {
            Swal.close();
        }
        
        console.log(`‚úÖ Recarga completa procesada correctamente - Modo: ${modo}`);
    } else {
        console.error('Error en recarga completa:', response ? response.error : 'Respuesta inv√°lida');
        if (Swal.isVisible()) {
            Swal.close();
        }
        Swal.fire({
            title: 'Error en Recarga',
            text: 'Hubo un problema durante la recarga completa de datos.',
            icon: 'error',
            confirmButtonText: 'Entendido'
        });
    }
}

// Funci√≥n para manejar errores de recarga completa
function handleErrorRecarga(error) {
    console.error("Error en recarga completa:", error);
    
    // Cerrar el modal de carga
    if (Swal.isVisible()) {
        Swal.close();
    }
    
    // Mostrar mensaje de error
    Swal.fire({
        title: 'Error en Recarga',
        text: 'Hubo un problema durante la recarga completa. Int√©ntalo de nuevo m√°s tarde.',
        icon: 'error',
        confirmButtonText: 'Entendido'
    });
}

// Nueva funci√≥n para manejar la respuesta de los l√≠deres
function handleLideresResponse(response) {
    if (response && response.success) {
        console.log('Lista de l√≠deres recibida.');
        console.log('üìä Datos de l√≠deres:', response.data);
        llenarSelectorLD(response.data); // Funci√≥n que llena el men√∫ desplegable
    } else {
        console.error("No se pudo cargar la lista de l√≠deres.");
        llenarSelectorLD([]); // Llena el selector con un error
    }
    // El loader se oculta en handleDatosCompletosResponse cuando se cargan las alertas
}

        // Recargar datos (Fuerza la recarga desde Sheets)
        function recargarDatos() {
            console.log('Forzando actualizaci√≥n (forceReloadDashboardData)...');
             Swal.fire({
                title: 'Actualizando datos...',
                text: 'Conectando con Google Sheets y recalculando m√©tricas. Esto puede tardar un momento.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            // Llama a la funci√≥n del backend que ignora la cach√©
            google.script.run
                .withSuccessHandler(handleRecargaCompleta)
                .withFailureHandler(handleErrorRecarga)
                .forceReloadDashboardData();
        }

        // Funci√≥n gen√©rica para obtener datos del backend
        function fetchData(endpoint, isReload = false) {
    if (typeof google === 'undefined' || !google.script?.run) {
        handleDataFailure('Google Script API no disponible.');
        return;
    }

    google.script.run
        .withSuccessHandler(response => {
            console.log('Respuesta del servidor:', response);
            handleDataResponse(response, isReload);
        })
        .withFailureHandler(error => {
            console.error('Error del servidor:', error);
            handleDataFailure(error.toString(), endpoint);
        })
        [endpoint]();
}

        // Manejador de respuesta exitosa
        function handleDataResponse(response, isReload) {
    console.log('Respuesta recibida:', response);
    
    // Verificar que la respuesta sea v√°lida
    if (!response) {
        console.error('Respuesta nula del servidor');
        handleDataFailure('No se recibi√≥ respuesta del servidor');
        return;
    }
    
    // Verificar estructura de respuesta
    if (response.success === false) {
        console.error('Error en respuesta:', response.error);
        handleDataFailure(response.error || 'Error desconocido');
        return;
    }
    
    // Verificar que tenga data
    if (!response.data) {
        console.error('Respuesta sin data');
        handleDataFailure('Respuesta sin datos');
        return;
    }
    
    // TODO BIEN - Procesar datos
    datosActuales = response.data;
    window.datosActuales = response.data; // Guardar globalmente
    
    console.log('Datos procesados:', {
        actividad: datosActuales.actividad || {},
        metricas: datosActuales.metricas || {},
        lideres: datosActuales.lideres?.lista?.length || 0,
        alertas: datosActuales.alertas?.length || 0
    });
    
    actualizarInterfaz();
    document.getElementById('loader').style.display = 'none';
    
    if (isReload) {
        if (ldSeleccionado) {
            cargarDatosLD(true);
        }
        Swal.fire({
            icon: 'success',
            title: 'Datos Actualizados',
            text: 'La informaci√≥n ha sido actualizada.',
            timer: 2000,
            showConfirmButton: false
        });
    }
}

        // Manejador de fallos
        function handleDataFailure(error, endpoint = '') {
            console.error('Error en la carga de datos:', error);
            document.getElementById('loader').style.display = 'none';

            if (Swal.isVisible()) Swal.close();

            // Manejo espec√≠fico si la funci√≥n de recarga forzada no existe
            if (endpoint === 'forceReloadDashboardData' && error.includes('no es una funci√≥n')) {
                error = 'La funci√≥n "forceReloadDashboardData" no existe en Code.gs. Debes a√±adirla para usar la actualizaci√≥n forzada.';
            }

            mostrarErrorConfiguracion(error);
        }
        
        // Mostrar error de configuraci√≥n
        function mostrarErrorConfiguracion(mensaje) {
            const errorDiv = document.getElementById('errorConfig');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = mensaje;
            errorDiv.classList.remove('hidden');
        }
        
        // ==================== ACTUALIZACI√ìN DE INTERFAZ ====================

        // Actualizar interfaz completa
        // Variable global para conservar estad√≠sticas
        let ultimasEstadisticas = null;
        
        function actualizarInterfaz() {
            if (!datosActuales) return;
            
            actualizarTimestamp();
            
            // ‚úÖ CORRECCI√ìN: Usar estad√≠sticas guardadas o datos actuales
            if (ultimasEstadisticas) {
                actualizarEstadisticas(ultimasEstadisticas);
            } else if (datosActuales.fila1 && datosActuales.fila2) {
                // ‚úÖ CORRECCI√ìN: Usar estructura alineada {fila1, fila2, calculadas}
                actualizarEstadisticas(datosActuales);
            } else {
                console.warn('‚ö†Ô∏è No hay estad√≠sticas disponibles para mostrar');
            }
            
            // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido
            
            // ‚úÖ CORRECCI√ìN: Llenar selector solo si hay datos v√°lidos
            if (datosActuales.lideres?.lista && datosActuales.lideres.lista.length > 0) {
                llenarSelectorLD(datosActuales.lideres.lista);
            } else if (document.getElementById('ldSelector').options.length <= 1) {
                console.warn('‚ö†Ô∏è No hay lista de l√≠deres disponible para el selector');
            }
        }

         // Actualizar Timestamp (NUEVO V2.0)
        function actualizarTimestamp() {
            const timestampElement = document.getElementById('dataTimestamp');
            if (datosActuales.timestamp) {
                try {
                    const date = new Date(datosActuales.timestamp);
                    // Formatear fecha para mejor lectura local
                    timestampElement.textContent = date.toLocaleString('es-ES', { 
                        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true
                    });
                } catch (e) {
                    timestampElement.textContent = 'N/A';
                }
            }
        }

        
        
        // Actualizar estad√≠sticas generales (ACTUALIZADA PARA 8 M√âTRICAS EN 2 FILAS)
function actualizarEstadisticas(stats) {
    const container = document.getElementById('estadisticasGenerales');
    if (!stats) {
        console.error('‚ùå No se pudieron cargar las estad√≠sticas');
        container.innerHTML = `<p class="text-red-500">No se pudieron cargar las estad√≠sticas.</p>`;
        return;
    }

    // Acceso a las nuevas m√©tricas organizadas en filas
    const fila1 = stats.fila1 || {};
    const fila2 = stats.fila2 || {};
    const calculadas = stats.calculadas || {};
    
    container.innerHTML = `
        <!-- FILA 1: M√©tricas Principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Activos Recibiendo C√©lula</p>
                        <p class="text-3xl font-bold text-blue-600">${fila1.activos_recibiendo_celula || 0}</p>
                        <p class="text-xs text-blue-600">${calculadas.porcentaje_activos || 0}% del total</p>
                    </div>
                    <i class="fas fa-users text-blue-500 text-3xl"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">L√≠deres Hibernando</p>
                        <p class="text-3xl font-bold text-green-600">${fila1.lideres_hibernando || 0}</p>
                    </div>
                    <i class="fas fa-user-slash text-green-500 text-3xl"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total L√≠deres</p>
                        <p class="text-3xl font-bold text-yellow-600">${fila1.total_lideres || 0}</p>
                    </div>
                    <i class="fas fa-user-tie text-yellow-500 text-3xl"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Asistencia C√©lulas</p>
                        <p class="text-3xl font-bold text-blue-600">${fila1.total_asistentencia_celulas || 0}</p>
                    </div>
                    <i class="fas fa-chart-line text-blue-500 text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- FILA 2: M√©tricas Secundarias -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">2-3 Semanas Sin C√©lula</p>
                        <p class="text-3xl font-bold text-purple-600">${fila2.alerta_2_3_semanas || 0}</p>
                        <p class="text-xs text-purple-600">${calculadas.porcentaje_alerta || 0}% del total</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-purple-500 text-3xl"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">+1 Mes Sin C√©lula</p>
                        <p class="text-3xl font-bold text-red-600">${fila2.critico_mas_1_mes || 0}</p>
                        <p class="text-xs text-red-600">${calculadas.porcentaje_critico || 0}% del total</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-red-500 text-3xl"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total C√©lulas</p>
                        <p class="text-3xl font-bold text-teal-600">${fila2.total_celulas || 0}</p>
                    </div>
                    <i class="fas fa-home text-teal-500 text-3xl"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Ingresos</p>
                        <p class="text-3xl font-bold text-pink-600">${fila2.total_ingresos || 0}</p>
                    </div>
                    <i class="fas fa-user-plus text-pink-500 text-3xl"></i>
                </div>
            </div>
        </div>
    `;
}
        
        // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido para mejorar rendimiento

        /**
         * Funci√≥n para volver al home del dashboard
         */
        function irAHome() {
            console.log('üè† Navegando al home del dashboard');
            
            // Ocultar todas las secciones espec√≠ficas
            document.getElementById('resumenLD').classList.add('hidden');
            document.getElementById('panelLCFs').classList.add('hidden');
            document.getElementById('accionesLD').classList.add('hidden');
            
            // Mostrar estad√≠sticas generales
            document.getElementById('estadisticasGenerales').classList.remove('hidden');
            
            // Limpiar selector de LD
            const ldSelector = document.getElementById('ldSelector');
            if (ldSelector) {
                ldSelector.value = '';
            }
            
            // Cerrar cualquier modal abierto
            if (typeof Swal !== 'undefined') {
                Swal.close();
            }
            
            console.log('‚úÖ Vista home restaurada');
        }

        /**
 * Inicia el proceso para ver el resumen de un LCF.
 */
function verResumenLCF(idLCF, nombreLCF) {
  Swal.fire({
    title: 'Cargando Resumen...',
    text: `Obteniendo m√©tricas para ${nombreLCF}`,
    allowOutsideClick: false,
    didOpen: () => { Swal.showLoading(); }
  });

  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        mostrarModalResumen(nombreLCF, response.data);
      } else {
        Swal.fire('Error', response.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      Swal.fire('Error de Conexi√≥n', error.toString(), 'error');
    })
    .getResumenLCF(idLCF);
}

/**
 * Muestra el modal de resumen con las m√©tricas del LCF.
 */
function mostrarModalResumen(nombreLCF, data) {
  const tasaBienvenida = data.totalAlmas > 0 ? ((data.conBienvenida / data.totalAlmas) * 100).toFixed(0) : 0;
  const tasaVisita = data.totalAlmas > 0 ? ((data.conVisita / data.totalAlmas) * 100).toFixed(0) : 0;
  const tasaCelula = data.totalAlmas > 0 ? ((data.enCelula / data.totalAlmas) * 100).toFixed(0) : 0;

  const htmlContent = `
    <div class="text-left space-y-4">
      <div class="grid grid-cols-2 gap-4 text-center">
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-3xl font-bold text-blue-600">${data.totalAlmas}</p>
          <p class="text-sm text-gray-600">Almas Asignadas</p>
        </div>
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-3xl font-bold text-purple-600">${tasaCelula}%</p>
          <p class="text-sm text-gray-600">Integraci√≥n a C√©lula</p>
        </div>
      </div>
      <div class="space-y-2">
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-sm font-medium text-gray-700">Bienvenidas</span>
            <span class="text-sm font-medium text-gray-700">${tasaBienvenida}%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${tasaBienvenida}%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-sm font-medium text-gray-700">Visitas</span>
            <span class="text-sm font-medium text-gray-700">${tasaVisita}%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div class="bg-yellow-500 h-2.5 rounded-full" style="width: ${tasaVisita}%"></div>
          </div>
        </div>
      </div>
    </div>
  `;

  Swal.fire({
    title: `Resumen de: ${nombreLCF}`,
    html: htmlContent,
    icon: 'info',
    confirmButtonText: 'Cerrar'
  });
}
        
        // Llenar selector de LD (ahora recibe la lista como argumento)
function llenarSelectorLD(listaLDs) {
    const selector = document.getElementById('ldSelector');
    selector.innerHTML = '<option value="">-- Selecciona un L√≠der de Disc√≠pulos (LD) --</option>';

    // ‚úÖ CORRECCI√ìN: Usar argumento o fallback a datosActuales
    const listaParaUsar = listaLDs || (datosActuales?.lideres?.lista) || [];

    if (listaParaUsar && listaParaUsar.length > 0) {
        listaParaUsar.sort((a, b) => (a.Nombre_Lider || "").localeCompare(b.Nombre_Lider || ""));
        listaParaUsar.forEach(ld => {
            const option = document.createElement('option');
            option.value = ld.ID_Lider;
            option.textContent = ld.Nombre_Lider || ld.ID_Lider;
            selector.appendChild(option);
        });
        console.log(`‚úÖ Selector LD llenado con ${listaParaUsar.length} l√≠deres`);
    } else {
        selector.innerHTML = '<option value="">-- No se pudieron cargar los LDs --</option>';
        console.warn('‚ö†Ô∏è No hay datos de l√≠deres para llenar el selector');
    }
}
        
        // Cargar datos de un LD espec√≠fico
        function cargarDatosLD(silent = false) {
            const selector = document.getElementById('ldSelector');
            
            // Determinar el LD seleccionado (maneja cambios de selector y recargas silenciosas)
            if (!silent) {
                ldSeleccionado = selector.value;
            } else if (ldSeleccionado && selector.value !== ldSeleccionado) {
                selector.value = ldSeleccionado;
            }

            
            if (!ldSeleccionado) {
                // Limpiar vista si no hay selecci√≥n
                document.getElementById('estadisticasGenerales').classList.remove('hidden');
                document.getElementById('resumenLD').classList.add('hidden');
                // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido
                document.getElementById('panelLCFs').classList.add('hidden');
                document.getElementById('accionesLD').classList.add('hidden');
                return;
            }
            
            // Ocultar estad√≠sticas generales cuando hay LD seleccionado
            document.getElementById('estadisticasGenerales').classList.add('hidden');
            
            // Mostrar loader (Solo si no es silencioso)
            if (!silent) {
                Swal.fire({
                    title: 'Cargando equipo...',
                    text: 'Analizando datos del LD seleccionado.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            }
            
            
            // Llamar al backend (getDatosLD usa los datos cacheados eficientemente)
            google.script.run
                .withSuccessHandler(function(response) {
    if (!silent) Swal.close();
    
    // CR√çTICO: Guardar en ambas variables globales ANTES de verificar
    window.datosLD = response;
    datosLD = response;
    
    console.log('Datos LD recibidos:', response);
    console.log('datosLD guardado globalmente:', !!window.datosLD);
    
    if (response?.success) {
        mostrarDatosLD();
        document.getElementById('accionesLD').classList.remove('hidden');
    } else {
        mostrarError(response?.error ?? 'Error cargando datos del LD.');
    }
})
                .withFailureHandler(function(error) {
                    if (!silent) Swal.close();
                    mostrarError('Error de conexi√≥n al cargar LD: ' + error);
                })
                .getDatosLD(ldSeleccionado, true)
        }
        
        // Mostrar datos del LD
        function mostrarDatosLD() {
            if (!datosLD?.resumen) return;
            
            mostrarResumenLD();
            // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido
            mostrarEquipoLD();
        }
        
        // Actualizar la funci√≥n mostrarResumenLD para incluir la estructura
function mostrarResumenLD() {
    const resumen = datosLD.resumen;
    const container = document.getElementById('resumenLD');
    
    const estadoLD = resumen.ld?.Estado ?? 'Desconocido';
    const estadoColor = getEstadoColor(estadoLD);
    
    container.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                Resumen de: ${resumen.ld?.Nombre ?? 'L√≠der'}
            </h3>
            <span class="status-badge ${estadoColor}">Estado LD: ${estadoLD}</span>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <!-- 1. Total Almas -->
            <div class="text-center p-3 bg-blue-50 rounded">
                <p class="text-3xl font-bold text-blue-600">${resumen.Total_Ingresos ?? 0}</p>
                <p class="text-sm text-gray-600">Total Almas</p>
            </div>
            
            <!-- 2. Almas sin C√©lula - TEMPORALMENTE REMOVIDO PARA CORRECCI√ìN -->
            <!-- <div class="text-center p-3 bg-orange-50 rounded">
                <p class="text-3xl font-bold text-orange-600">${(resumen.Total_Ingresos ?? 0) - (resumen.Ingresos_En_Celula ?? 0)}</p>
                <p class="text-sm text-gray-600">Almas sin C√©lula</p>
            </div> -->
            
            <!-- 3. Recibiendo C√©lula (suma de todos los LCF del equipo) -->
            <div class="text-center p-3 bg-teal-50 rounded">
                <p class="text-3xl font-bold text-teal-600">${(() => {
                    const total = datosLD.equipo?.reduce((sum, lcf) => sum + (lcf.Recibiendo_Celula || 0), 0) || 0;
                    return total;
                })()}</p>
                <p class="text-sm text-gray-600">Recibiendo C√©lula</p>
            </div>
            
            <!-- 4. LCF Productivos (IDP > 15) -->
            <div class="text-center p-3 bg-green-50 rounded">
                <p class="text-3xl font-bold text-green-600">${(() => {
                    const productivos = datosLD.equipo?.filter(lcf => (lcf.IDP || 0) > 15).length || 0;
                    return productivos;
                })()}</p>
                <p class="text-sm text-gray-600">LCF Productivos</p>
            </div>
            
            <!-- 5. LCF Hibernando (Dias_Inactivo > 19 o IDP = 0) -->
            <div class="text-center p-3 bg-red-50 rounded">
                <p class="text-3xl font-bold text-red-600">${(() => {
                    const hibernando = datosLD.equipo?.filter(lcf => 
                        (lcf.Dias_Inactivo !== null && lcf.Dias_Inactivo > 19) || 
                        (lcf.IDP === 0 || lcf.Perfil_Lider?.includes('INACTIVO'))
                    ).length || 0;
                    return hibernando;
                })()}</p>
                <p class="text-sm text-gray-600">LCF Hibernando</p>
            </div>
            
            <!-- 6. Total LCF -->
            <div class="text-center p-3 bg-purple-50 rounded">
                <p class="text-3xl font-bold text-purple-600">${resumen.Total_LCF ?? 0}</p>
                <p class="text-sm text-gray-600">Total LCF</p>
            </div>
        </div>
        
        ${resumen.alertas?.criticas && resumen.alertas.criticas.length > 0 ? `
            <div class="mt-4 bg-red-50 border-l-4 border-red-500 p-3 rounded">
                <p class="text-sm font-semibold text-red-800">Alertas Cr√≠ticas:</p>
                <ul class="text-xs text-red-700 mt-1">
                    ${resumen.alertas.criticas.map(a => `<li>‚Ä¢ ${a.mensaje}</li>`).join('')}
                </ul>
            </div>
        ` : ''}
    `;
    
    container.classList.remove('hidden');
}
       
        
        // ‚úÖ ALERTAS ELIMINADAS: Sistema de alertas innecesario removido para mejorar rendimiento
        
       /**
 * Muestra el equipo completo con estructura jer√°rquica
 */
function mostrarEquipoLD() {
    if (!datosLD || !datosLD.success) return;
    
    // FIX: Asegurar que todas las m√©tricas existan
    if (datosLD.cadenas_lm) {
        datosLD.cadenas_lm.forEach(lm => {
            if (!lm.metricas) {
                lm.metricas = {
                    total_small_groups: lm.smallGroups ? lm.smallGroups.length : 0,
                    total_lcf_en_cadena: 0,
                    total_almas_en_cadena: 0
                };
            }
        });
    }
    
    if (datosLD.small_groups_directos) {
        datosLD.small_groups_directos.forEach(sg => {
            if (!sg.metricas) {
                sg.metricas = {
                    total_lcf: sg.lcfs ? sg.lcfs.length : 0,
                    lcf_activos: 0,
                    total_almas: 0
                };
            }
        });
    }
    
    if (datosLD.lcf_directos) {
        datosLD.lcf_directos.forEach(lcf => {
            if (!lcf.metricas) {
                lcf.metricas = {
                    total_almas: 0,
                    almas_en_celula: 0,
                    almas_sin_celula: 0,
                    carga_trabajo: 'Sin Datos'
                };
            }
        });
    }
    
    const container = document.getElementById('gridLCFs');
    let html = '';
    
    // Cambiar el t√≠tulo a uno m√°s descriptivo
    document.querySelector('#panelLCFs h2').innerHTML = `
        <i class="fas fa-sitemap text-purple-600 mr-2"></i>
        Estructura Organizacional - ${datosLD.resumen.ld.Nombre}
    `;
    
    // 1. MOSTRAR CADENAS LM
    if (datosLD.cadenas_lm && datosLD.cadenas_lm.length > 0) {
        html += `<div class="col-span-full mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-users text-blue-600 mr-2"></i>
                L√≠deres de Multiplicaci√≥n (${datosLD.cadenas_lm.length})
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">`;
        
        datosLD.cadenas_lm.forEach(lm => {
    html += crearTarjetaLMConReporte(lm); // Usar la nueva funci√≥n
  });
        
        html += `</div></div>`;
    }
    
    // 2. MOSTRAR SMALL GROUPS DIRECTOS (Sin LM)
    if (datosLD.small_groups_directos && datosLD.small_groups_directos.length > 0) {
        html += `<div class="col-span-full mb-6">
            <h3 class="text-xl font-bold text-orange-700 mb-4 flex items-center">
                <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
                Small Groups sin LM (${datosLD.small_groups_directos.length})
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
        
        datosLD.small_groups_directos.forEach(sg => {
            html += crearTarjetaSGDirecto(sg);
        });
        
        html += `</div></div>`;
    }
    
    // 3. MOSTRAR LCF DIRECTOS (Sin cadena de supervisi√≥n)
    if (datosLD.lcf_directos && datosLD.lcf_directos.length > 0) {
        html += `<div class="col-span-full">
            <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                <i class="fas fa-user-slash text-red-500 mr-2"></i>
                LCF sin Supervisi√≥n Intermedia (${datosLD.lcf_directos.length})
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">`;
        
        datosLD.lcf_directos.forEach(lcf => {
    html += crearTarjetaLCFDirectoConReporte(lcf); // Usar la nueva funci√≥n
  });
        
        html += `</div></div>`;
    }
    
    container.innerHTML = html || '<p class="col-span-full text-center text-gray-500 py-8">No hay equipo asignado a este LD</p>';
    document.getElementById('panelLCFs').classList.remove('hidden');
}
        
        // Ver detalles de un LCF (Adaptado V2.0 - Data Access y Visualizaci√≥n Integraci√≥n)
function verDetallesLCF(idLCF) {
    console.log('Cargando detalles para LCF:', idLCF);
    
    // Mostrar loading
    Swal.fire({
        title: 'Cargando detalles...',
        text: 'Obteniendo informaci√≥n del LCF',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });
    
    // Cargar datos del LCF
    google.script.run
        .withSuccessHandler(function(result) {
            Swal.close();
            
            if (result && result.success) {
                // Buscar el LCF para obtener su nombre
                let nombreLCF = 'LCF';
                if (datosLD) {
                    // Buscar en todas las estructuras
                    datosLD.lcf_directos?.forEach(lcf => {
                        if (lcf.ID_Lider === idLCF) nombreLCF = lcf.Nombre_Lider;
                    });
                    datosLD.cadenas_lm?.forEach(lm => {
                        lm.smallGroups?.forEach(sg => {
                            sg.lcfs?.forEach(lcf => {
                                if (lcf.ID_Lider === idLCF) nombreLCF = lcf.Nombre_Lider;
                            });
                        });
                        lm.lcfDirectos?.forEach(lcf => {
                            if (lcf.ID_Lider === idLCF) nombreLCF = lcf.Nombre_Lider;
                        });
                    });
                }
                
                mostrarModalDetallesLCF({
                    ID_Lider: idLCF,
                    Nombre_Lider: nombreLCF
                }, result.celulas || [], result.almas || []);
            } else {
                Swal.fire('Error', result?.error || 'No se pudieron cargar los datos', 'error');
            }
        })
        .withFailureHandler(function(error) {
            Swal.close();
            Swal.fire('Error', error.toString(), 'error');
        })
        .cargarDatosLCF(idLCF);
}

function mostrarModalDetallesLCF(lcfBasico, celulas, almas) {
    const modal = document.getElementById('modalLCF');
    const titulo = document.getElementById('modalTitulo');
    const contenido = document.getElementById('modalContenido');
    
    titulo.textContent = `Detalles: ${lcfBasico.Nombre_Lider}`;
    
    contenido.innerHTML = `
        <div class="mb-6">
            <h4 class="text-lg font-semibold mb-3 border-b pb-2">Resumen de Actividad</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-3 bg-blue-50 rounded">
                    <p class="text-2xl font-bold text-blue-600">${almas.length}</p>
                    <p class="text-xs text-gray-600">Total Almas</p>
                </div>
                <div class="text-center p-3 bg-green-50 rounded">
                    <p class="text-2xl font-bold text-green-600">${almas.filter(a => !a.En_Celula && a.Dias_Desde_Ingreso < 30).length}</p>
                    <p class="text-xs text-gray-600">Nuevas (30 d√≠as)</p>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded">
                    <p class="text-2xl font-bold text-purple-600">${almas.filter(a => a.En_Celula).length}</p>
                    <p class="text-xs text-gray-600">En C√©lula</p>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded">
                    <p class="text-2xl font-bold text-orange-600">${almas.filter(a => a.Prioridad === 'Alta').length}</p>
                    <p class="text-xs text-gray-600">Prioridad Alta</p>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <h4 class="text-lg font-semibold mb-3 border-b pb-2">C√©lulas (${celulas.length})</h4>
            ${celulas.length > 0 ? `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${celulas.map(celula => `
                        <div class="bg-gray-50 border rounded p-3">
                            <p class="font-semibold">${celula.Nombre_Celula}</p>
                            <p class="text-sm text-gray-600">${celula.Total_Miembros} miembros - ${celula.Estado}</p>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500 italic">No hay c√©lulas registradas</p>'}
        </div>
        
        <div>
            <h4 class="text-lg font-semibold mb-3 border-b pb-2">Almas Asignadas (${almas.length})</h4>
            ${almas.length > 0 ? `
                <div class="overflow-x-auto max-h-80 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left">Nombre</th>
                                <th class="px-3 py-2">D√≠as</th>
                                <th class="px-3 py-2">Prioridad</th>
                                <th class="px-3 py-2">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${almas.map(alma => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-3 py-2">${alma.Nombre_Completo}</td>
                                    <td class="px-3 py-2 text-center ${alma.Dias_Desde_Ingreso > 30 ? 'text-red-600 font-bold' : ''}">${alma.Dias_Desde_Ingreso}</td>
                                    <td class="px-3 py-2 text-center">
                                        <span class="px-2 py-1 rounded text-xs ${
                                            alma.Prioridad === 'Alta' ? 'bg-red-100 text-red-700' :
                                            alma.Prioridad === 'Media' ? 'bg-yellow-100 text-yellow-700' :
                                            'bg-gray-100 text-gray-700'
                                        }">${alma.Prioridad}</span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        ${alma.En_Celula ? 
                                            '<i class="fas fa-check-circle text-green-500"></i>' : 
                                            '<i class="fas fa-times-circle text-red-500"></i>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p class="text-gray-500 italic">No hay almas asignadas</p>'}
        </div>
    `;
    
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}
        
 
function crearTarjetaLMConReporte(lm) {
  const estadoColor = getEstadoColor(lm.Estado_Actividad);
  
  return `
    <div class="bg-white rounded-lg shadow-lg overflow-hidden card-hover">
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4">
        <div class="flex justify-between items-start">
          <div>
            <h4 class="font-bold text-lg">${lm.Nombre_Lider}</h4>
            <p class="text-xs opacity-90">LM - ${lm.ID_Lider}</p>
            <p class="text-xs opacity-75 mt-1">üìä ${lm.metricas.total_almas_en_cadena} almas totales</p>
          </div>
          <span class="status-badge ${estadoColor}">
            ${lm.Estado_Actividad}
          </span>
        </div>
      </div>
      
      <div class="p-4">
        <div class="grid grid-cols-3 gap-2 text-center mb-4">
          <div class="bg-gray-50 rounded p-2">
            <div class="text-xl font-bold text-blue-600">${lm.metricas.total_small_groups}</div>
            <div class="text-xs text-gray-500">Small Groups</div>
          </div>
          <div class="bg-gray-50 rounded p-2">
            <div class="text-xl font-bold text-green-600">${lm.metricas.total_lcf_en_cadena}</div>
            <div class="text-xs text-gray-500">Total LCF</div>
          </div>
          <div class="bg-gray-50 rounded p-2">
            <div class="text-xl font-bold text-purple-600">${lm.metricas.total_almas_en_cadena}</div>
            <div class="text-xs text-gray-500">Almas</div>
          </div>
        </div>
        
        
        <button onclick="verDetalleCadenaLM('${lm.ID_Lider}')" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition text-sm">
          <i class="fas fa-sitemap mr-2"></i>
          Ver Cadena Completa
        </button>
      </div>
    </div>
  `;
}

/**
 * Crea tarjeta para Small Group directo (sin LM)
 */
function crearTarjetaSGDirecto(sg) {
    const estadoColor = getEstadoColor(sg.Estado_Actividad);
    
    return `
        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg shadow-md p-4">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-semibold text-gray-800">${sg.Nombre_Lider}</h4>
                    <p class="text-xs text-gray-500">SG - ${sg.ID_Lider}</p>
                    <span class="text-xs text-orange-600 font-medium">‚ö†Ô∏è Sin LM asignado</span>
                </div>
                <span class="status-badge ${estadoColor} text-xs">
                    ${sg.Estado_Actividad}
                </span>
            </div>
            
            <div class="grid grid-cols-3 gap-2 text-center mb-3">
                <div>
                    <div class="text-lg font-bold text-green-600">${sg.metricas.total_lcf}</div>
                    <div class="text-xs text-gray-500">LCF</div>
                </div>
                <div>
                    <div class="text-lg font-bold text-blue-600">${sg.metricas.lcf_activos}</div>
                    <div class="text-xs text-gray-500">Activos</div>
                </div>
                <div>
                    <div class="text-lg font-bold text-purple-600">${sg.metricas.total_almas}</div>
                    <div class="text-xs text-gray-500">Almas</div>
                </div>
            </div>
            
            <button onclick="verDetalleSG('${sg.ID_Lider}')" 
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded text-sm transition">
                Ver LCF del Grupo
            </button>
        </div>
    `;
}


// REEMPLAZAR crearTarjetaLCFDirectoConReporte con esta versi√≥n:
function crearTarjetaLCFDirectoConReporte(lcf) {
  const estadoColor = getEstadoColor(lcf.Perfil_Lider || lcf.Estado_Actividad);
  const cargaColor = getCargaColor(lcf.metricas.carga_trabajo);
  
  // ‚úÖ HYBRID: Mostrar d√≠as de inactividad si est√°n disponibles
  const diasInactivo = lcf.Dias_Inactivo !== null && lcf.Dias_Inactivo !== undefined ? lcf.Dias_Inactivo : null;
  
  // ‚úÖ CORRECCI√ìN: Si es 999, mostrar "Sin Datos" en lugar de "999 d√≠as"
  let diasTexto, diasColor, mostrarDias;
  
  if (diasInactivo === null || diasInactivo === undefined) {
    mostrarDias = false; // No mostrar nada
  } else if (diasInactivo >= 999) {
    diasTexto = 'Sin Datos';
    diasColor = 'text-gray-500';
    mostrarDias = true;
  } else if (diasInactivo <= 7) {
    diasTexto = `${diasInactivo} d√≠as`;
    diasColor = 'text-green-600';
    mostrarDias = true;
  } else if (diasInactivo <= 14) {
    diasTexto = `${diasInactivo} d√≠as`;
    diasColor = 'text-yellow-600';
    mostrarDias = true;
  } else {
    diasTexto = `${diasInactivo} d√≠as`;
    diasColor = 'text-red-600';
    mostrarDias = true;
  }
  
  return `
    <div class="bg-red-50 border border-red-200 rounded-lg shadow p-3">
      <div class="mb-2">
        <h5 class="font-semibold text-sm text-gray-800 truncate">${lcf.Nombre_Lider}</h5>
        <p class="text-xs text-gray-500">${lcf.ID_Lider}</p>
        <div class="flex gap-1 mt-1">
          <span class="status-badge ${estadoColor} text-xs">
            ${lcf.Perfil_Lider || lcf.Estado_Actividad}
          </span>
          ${mostrarDias ? `<span class="text-xs ${diasColor} font-semibold">üìÖ ${diasTexto}</span>` : ''}
        </div>
      </div>
      
      <div class="grid grid-cols-3 gap-2 text-center text-xs mb-2">
        <div class="bg-white rounded p-1">
          <div class="font-bold text-blue-600">${lcf.metricas.total_almas}</div>
          <div class="text-gray-500">Almas</div>
        </div>
        <div class="bg-white rounded p-1">
          <div class="font-bold text-green-600">${lcf.Recibiendo_Celula || 0}</div>
          <div class="text-gray-500">En C√©lula</div>
        </div>
        <div class="bg-white rounded p-1">
          <div class="font-bold text-purple-600">${lcf.IDP || 0}</div>
          <div class="text-gray-500">IDP</div>
        </div>
      </div>
      
      <span class="status-badge ${cargaColor} text-xs">
        Carga: ${lcf.metricas.carga_trabajo}
      </span>
      
      <div class="grid grid-cols-2 gap-1 mt-2">
        <!-- Primera fila de botones -->
        <button onclick="verResumenLCF('${lcf.ID_Lider}', '${lcf.Nombre_Lider.replace(/'/g, "\\'")}')"
              class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded text-xs transition"
              title="Ver Resumen de M√©tricas">
           <i class="fas fa-chart-line text-xs"></i> Resumen
      </button>
        <!-- Segunda fila de botones -->
        <button onclick="generarReporteLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')"
                      class="bg-green-600 hover:bg-green-700 text-white py-1 px-2 rounded text-xs transition"
                      title="PDF">
                <i class="fas fa-file-pdf text-xs"></i> PDF
              </button>
        <button onclick="verSeguimientoAlmasLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')" 
                class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded text-xs transition"
                title="Seguimiento">
          <i class="fas fa-chart-bar text-xs"></i> Seg.
        </button>
      </div>
    </div>
  `;
}

/**
 * Ver detalle de cadena LM (expandir jerarqu√≠a completa)
 */
function verDetalleCadenaLM(idLM) {
    const lm = datosLD.cadenas_lm.find(l => l.ID_Lider === idLM);
    if (!lm) return;
    
    const modal = document.getElementById('modalLCF');
    const titulo = document.getElementById('modalTitulo');
    const contenido = document.getElementById('modalContenido');
    
    titulo.innerHTML = `
        <i class="fas fa-sitemap mr-2"></i>
        Cadena de Supervisi√≥n: ${lm.Nombre_Lider}
    `;
    
    let html = `
        <div class="space-y-6">
            <!-- Resumen de la cadena -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-bold text-lg text-blue-800 mb-3">Resumen de la Cadena</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${lm.metricas?.total_small_groups || 0}</div>
                        <div class="text-sm text-gray-600">Small Groups</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${lm.metricas?.total_lcf_en_cadena || 0}</div>
                        <div class="text-sm text-gray-600">Total LCF</div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${lm.metricas?.lcf_en_small_groups || 0} en SG + ${lm.metricas?.lcf_directos || 0} directos
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">${lm.metricas?.total_almas_en_cadena || 0}</div>
                        <div class="text-sm text-gray-600">Total Almas</div>
                    </div>
                </div>
            </div>
            
            <!-- Estructura jer√°rquica -->
            <div>
                <h4 class="font-bold text-lg text-gray-800 mb-3">Estructura Organizacional</h4>
                
                <!-- Small Groups y sus LCF -->
                ${lm.smallGroups && lm.smallGroups.length > 0 ? lm.smallGroups.map(sg => `
                    <div class="mb-6 border-l-4 border-blue-500 pl-4">
                        <div class="bg-gray-50 rounded-lg p-3 mb-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">
                                        <i class="fas fa-users-cog mr-2 text-gray-600"></i>
                                        ${sg.Nombre_Lider}
                                    </h5>
                                    <p class="text-sm text-gray-500">Small Group - ${sg.ID_Lider}</p>
                                </div>
                                <span class="status-badge ${getEstadoColor(sg.Estado_Actividad)}">
                                    ${sg.Estado_Actividad}
                                </span>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                ${sg.metricas?.total_lcf || 0} LCF | 
                                ${sg.metricas?.total_almas || 0} almas | 
                                ${sg.metricas?.lcf_activos || 0} activos
                            </div>
                        </div>
                        
                        <!-- LCF del Small Group -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 ml-4">
                            ${sg.lcfs && sg.lcfs.length > 0 ? sg.lcfs.map(lcf => {
                                const diasInactivo = lcf.Dias_Inactivo !== null && lcf.Dias_Inactivo !== undefined ? lcf.Dias_Inactivo : null;
                                
                                // ‚úÖ CORRECCI√ìN: Si es 999, mostrar "Sin Datos"
                                let diasTexto, diasColor, mostrarDias;
                                if (diasInactivo === null || diasInactivo === undefined) {
                                  mostrarDias = false;
                                } else if (diasInactivo >= 999) {
                                  diasTexto = 'Sin Datos';
                                  diasColor = 'text-gray-500';
                                  mostrarDias = true;
                                } else if (diasInactivo <= 7) {
                                  diasTexto = `${diasInactivo}d`;
                                  diasColor = 'text-green-600';
                                  mostrarDias = true;
                                } else if (diasInactivo <= 14) {
                                  diasTexto = `${diasInactivo}d`;
                                  diasColor = 'text-yellow-600';
                                  mostrarDias = true;
                                } else {
                                  diasTexto = `${diasInactivo}d`;
                                  diasColor = 'text-red-600';
                                  mostrarDias = true;
                                }
                                
                                const estadoColor = getEstadoColor(lcf.Perfil_Lider || lcf.Estado_Actividad);
                                return `
                                <div class="bg-white border rounded p-2 text-sm">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-gray-800">${lcf.Nombre_Lider}</p>
                                            <p class="text-xs text-gray-500">${lcf.ID_Lider}</p>
                                        </div>
                                        <span class="status-badge ${estadoColor} text-xs">
                                            ${lcf.Perfil_Lider || lcf.Estado_Actividad}
                                        </span>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-600">
                                        ${lcf.metricas?.total_almas || 0} almas | ${lcf.Recibiendo_Celula || 0} en c√©lula${mostrarDias ? ` | <span class="${diasColor} font-semibold">üìÖ ${diasTexto}</span>` : ''}
                                    </div>
                                    <div class="mt-1 flex gap-2 items-center text-xs">
                                        <span class="text-purple-600 font-semibold">IDP: ${lcf.IDP || 0}</span>
                                        <span class="status-badge ${getCargaColor(lcf.metricas?.carga_trabajo)} text-xs">
                                            Carga: ${lcf.metricas?.carga_trabajo || 'N/A'}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2 grid grid-cols-3 gap-1">
                                      <button onclick="navegarDesdeModalA('verResumenLCF', '${lcf.ID_Lider}', '${lcf.Nombre_Lider.replace(/'/g, "\\'")}')"
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-1 py-1 rounded text-xs"
                                            title="Ver Resumen de M√©tricas">
                                        <i class="fas fa-chart-line text-xs"></i>
                                    </button>
                                      <button onclick="navegarDesdeModalA('verSeguimientoAlmasLCF', '${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')"
                                             class="bg-purple-600 hover:bg-purple-700 text-white px-1 py-1 rounded text-xs"
                                            title="Seguimiento detallado">
                                            <i class="fas fa-chart-bar text-xs"></i>
                                        </button>
                                        <button onclick="navegarDesdeModalA('generarReporteLCF', '${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-1 py-1 rounded text-xs"
                                                title="PDF">
                                            <i class="fas fa-file-pdf text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            `;}).join('') : '<p class="text-gray-500 text-xs">Sin LCF asignados</p>'}
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-500">No hay Small Groups en esta cadena</p>'}
                
                <!-- LCF directos del LM (sin SG) -->
                ${lm.lcfDirectos && lm.lcfDirectos.length > 0 ? `
                    <div class="mt-6 border-l-4 border-orange-500 pl-4">
                        <h5 class="font-semibold text-orange-700 mb-3">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            LCF reportando directamente (sin Small Group)
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${lm.lcfDirectos.map(lcf => {
                                const diasInactivo = lcf.Dias_Inactivo !== null && lcf.Dias_Inactivo !== undefined ? lcf.Dias_Inactivo : null;
                                
                                // ‚úÖ CORRECCI√ìN: Si es 999, mostrar "Sin Datos"
                                let diasTexto, diasColor, mostrarDias;
                                if (diasInactivo === null || diasInactivo === undefined) {
                                  mostrarDias = false;
                                } else if (diasInactivo >= 999) {
                                  diasTexto = 'Sin Datos';
                                  diasColor = 'text-gray-500';
                                  mostrarDias = true;
                                } else if (diasInactivo <= 7) {
                                  diasTexto = `${diasInactivo}d`;
                                  diasColor = 'text-green-600';
                                  mostrarDias = true;
                                } else if (diasInactivo <= 14) {
                                  diasTexto = `${diasInactivo}d`;
                                  diasColor = 'text-yellow-600';
                                  mostrarDias = true;
                                } else {
                                  diasTexto = `${diasInactivo}d`;
                                  diasColor = 'text-red-600';
                                  mostrarDias = true;
                                }
                                
                                const estadoColor = getEstadoColor(lcf.Perfil_Lider || lcf.Estado_Actividad);
                                return `
                                <div class="bg-orange-50 border border-orange-200 rounded p-2 text-sm">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-medium">${lcf.Nombre_Lider}</p>
                                            <p class="text-xs text-gray-500">${lcf.ID_Lider}</p>
                                        </div>
                                        <span class="status-badge ${estadoColor} text-xs">
                                            ${lcf.Perfil_Lider || lcf.Estado_Actividad}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        ${lcf.metricas?.total_almas || 0} almas | ${lcf.Recibiendo_Celula || 0} en c√©lula${mostrarDias ? ` | <span class="${diasColor} font-semibold">üìÖ ${diasTexto}</span>` : ''}
                                    </div>
                                    <div class="mt-1 flex gap-2 items-center text-xs">
                                        <span class="text-purple-600 font-semibold">IDP: ${lcf.IDP || 0}</span>
                                        <span class="status-badge ${getCargaColor(lcf.metricas?.carga_trabajo)} text-xs">
                                            Carga: ${lcf.metricas?.carga_trabajo || 'N/A'}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2 grid grid-cols-3 gap-1">
    <button onclick="verResumenLCF('${lcf.ID_Lider}', '${lcf.Nombre_Lider.replace(/'/g, "\\'")}')"
            class="bg-blue-600 hover:bg-blue-700 text-white px-1 py-1 rounded text-xs"
            title="Ver Resumen de M√©tricas">
        <i class="fas fa-chart-line text-xs"></i>
    </button>
    <button onclick="verSeguimientoAlmasLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')" 
            class="bg-purple-600 hover:bg-purple-700 text-white px-1 py-1 rounded text-xs"
            title="Seguimiento">
        <i class="fas fa-chart-bar text-xs"></i>
    </button>
    <button onclick="generarReporteLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')" 
            class="bg-green-600 hover:bg-green-700 text-white px-1 py-1 rounded text-xs"
            title="PDF">
        <i class="fas fa-file-pdf text-xs"></i>
    </button>
</div>
                                </div>
                            `;}).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    contenido.innerHTML = html;
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}

// Funci√≥n para ver vista r√°pida desde el modal (para que funcione con la estructura anidada)
// Funci√≥n para ver vista r√°pida desde cualquier modal
function verVistaRapidaDesdeModal(idLCF, nombreLCF) {
    // Cerrar el modal actual
    cerrarModal();
    
    // Esperar un momento y abrir la vista r√°pida
    setTimeout(() => {
        verVistaRapidaLCF(idLCF, nombreLCF);
    }, 300);
}

// Funci√≥n para generar reporte PDF desde cualquier modal
function generarReporteLCFDesdeModal(idLCF, nombreLCF) {
    // Cerrar modal actual
    cerrarModal();
    
    // Esperar y generar reporte
    setTimeout(() => {
        generarReporteLCF(idLCF, nombreLCF);
    }, 300);
}


function verDetalleSG(idSG) {
    // Buscar el SG en todas las estructuras
    let sg = null;
    
    if (datosLD && datosLD.cadenas_lm) {
        datosLD.cadenas_lm.forEach(lm => {
            const found = lm.smallGroups.find(s => s.ID_Lider === idSG);
            if (found) sg = found;
        });
    }
    
    if (!sg && datosLD && datosLD.small_groups_directos) {
        sg = datosLD.small_groups_directos.find(s => s.ID_Lider === idSG);
    }
    
    if (!sg) {
        Swal.fire('Error', 'Small Group no encontrado', 'error');
        return;
    }
    
    const modal = document.getElementById('modalLCF');
    const titulo = document.getElementById('modalTitulo');
    const contenido = document.getElementById('modalContenido');
    
    titulo.innerHTML = `
        <i class="fas fa-users-cog mr-2"></i>
        Small Group: ${sg.Nombre_Lider}
    `;
    
    contenido.innerHTML = `
        <div class="space-y-4">
            <!-- Resumen del Small Group -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-3">Resumen del Grupo</h4>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-xl font-bold text-blue-600">${sg.metricas?.total_lcf || 0}</div>
                        <div class="text-xs text-gray-500">Total LCF</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-green-600">${sg.metricas?.lcf_activos || 0}</div>
                        <div class="text-xs text-gray-500">LCF Activos</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-purple-600">${sg.metricas?.total_almas || 0}</div>
                        <div class="text-xs text-gray-500">Total Almas</div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de LCF del grupo -->
            <div class="bg-white rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-3">LCF del Grupo (${sg.lcfs ? sg.lcfs.length : 0})</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${sg.lcfs && sg.lcfs.length > 0 ? sg.lcfs.map(lcf => {
                        const diasInactivo = lcf.Dias_Inactivo !== null && lcf.Dias_Inactivo !== undefined ? lcf.Dias_Inactivo : null;
                        
                        // ‚úÖ CORRECCI√ìN: Si es 999, mostrar "Sin Datos"
                        let diasTexto, diasColor, mostrarDias;
                        if (diasInactivo === null || diasInactivo === undefined) {
                          mostrarDias = false;
                        } else if (diasInactivo >= 999) {
                          diasTexto = 'Sin Datos';
                          diasColor = 'text-gray-500';
                          mostrarDias = true;
                        } else if (diasInactivo <= 7) {
                          diasTexto = `${diasInactivo}d`;
                          diasColor = 'text-green-600';
                          mostrarDias = true;
                        } else if (diasInactivo <= 14) {
                          diasTexto = `${diasInactivo}d`;
                          diasColor = 'text-yellow-600';
                          mostrarDias = true;
                        } else {
                          diasTexto = `${diasInactivo}d`;
                          diasColor = 'text-red-600';
                          mostrarDias = true;
                        }
                        
                        const estadoColor = getEstadoColor(lcf.Perfil_Lider || lcf.Estado_Actividad);
                        return `
                        <div class="bg-white border rounded p-2 text-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-gray-800">${lcf.Nombre_Lider}</p>
                                    <p class="text-xs text-gray-500">${lcf.ID_Lider}</p>
                                </div>
                                <span class="status-badge ${estadoColor} text-xs">
                                    ${lcf.Perfil_Lider || lcf.Estado_Actividad || 'Sin datos'}
                                </span>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">
                                ${lcf.metricas?.total_almas || 0} almas | ${lcf.Recibiendo_Celula || 0} en c√©lula${mostrarDias ? ` | <span class="${diasColor} font-semibold">üìÖ ${diasTexto}</span>` : ''}
                            </div>
                            <div class="mt-1 flex gap-2 items-center text-xs">
                                <span class="text-purple-600 font-semibold">IDP: ${lcf.IDP || 0}</span>
                                <span class="status-badge ${getCargaColor(lcf.metricas?.carga_trabajo)} text-xs">
                                    Carga: ${lcf.metricas?.carga_trabajo || 'N/A'}
                                </span>
                            </div>
                            
                            <div class="mt-2 grid grid-cols-3 gap-1">
                              <button onclick="verResumenLCF('${lcf.ID_Lider}', '${lcf.Nombre_Lider.replace(/'/g, "\\'")}')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-1 py-1 rounded text-xs"
                                    title="Ver Resumen de M√©tricas">
                                <i class="fas fa-chart-line text-xs"></i>
                            </button>
                              <button onclick="verSeguimientoAlmasLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')"
                                     class="bg-purple-600 hover:bg-purple-700 text-white px-1 py-1 rounded text-xs"
                                    title="Seguimiento detallado">
                                    <i class="fas fa-chart-bar text-xs"></i>
                                </button>
                                <button onclick="generarReporteLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-1 py-1 rounded text-xs"
                                        title="PDF">
                                    <i class="fas fa-file-pdf text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `;}).join('') : '<p class="text-center text-gray-500">No hay LCF en este grupo</p>'}
                </div>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}

function verSeguimientoDesdeModal(idLCF, nombreLCF) {
    cerrarModal();
    setTimeout(() => {
        if (typeof verSeguimientoAlmasLCF === 'function') {
            verSeguimientoAlmasLCF(idLCF, nombreLCF);
        } else {
            Swal.fire('Error', 'Funci√≥n de seguimiento no disponible', 'error');
        }
    }, 300);
}

function verDetalleLCF(idLCF) {
    // Buscar el LCF en todas las estructuras posibles
    let lcf = null;
    
    // Buscar en cadenas LM
    if (datosLD.cadenas_lm) {
        datosLD.cadenas_lm.forEach(lm => {
            lm.smallGroups.forEach(sg => {
                const found = sg.lcfs.find(l => l.ID_Lider === idLCF);
                if (found) lcf = found;
            });
            const foundDirect = lm.lcfDirectos.find(l => l.ID_Lider === idLCF);
            if (foundDirect) lcf = foundDirect;
        });
    }
    
    // Buscar en Small Groups directos
    if (!lcf && datosLD.small_groups_directos) {
        datosLD.small_groups_directos.forEach(sg => {
            const found = sg.lcfs.find(l => l.ID_Lider === idLCF);
            if (found) lcf = found;
        });
    }
    
    // Buscar en LCF directos
    if (!lcf && datosLD.lcf_directos) {
        lcf = datosLD.lcf_directos.find(l => l.ID_Lider === idLCF);
    }
    
    if (!lcf) {
        mostrarError('No se encontraron datos del LCF');
        return;
    }
    
    // Continuar con el resto de la funci√≥n usando lcf...
    const modal = document.getElementById('modalLCF');
    const titulo = document.getElementById('modalTitulo');
    const contenido = document.getElementById('modalContenido');
    
    titulo.textContent = `Detalles: ${lcf.Nombre_Lider}`;
    
    // Mostrar las m√©tricas del LCF
    contenido.innerHTML = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-3 bg-blue-50 rounded">
                    <p class="text-2xl font-bold text-blue-600">${lcf.metricas.total_almas}</p>
                    <p class="text-xs text-gray-600">Total Almas</p>
                </div>
                <div class="text-center p-3 bg-green-50 rounded">
                    <p class="text-2xl font-bold text-green-600">${lcf.Recibiendo_Celula || 0}</p>
                    <p class="text-xs text-gray-600">En C√©lula</p>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded">
                    <p class="text-2xl font-bold text-orange-600">${lcf.metricas.almas_sin_celula}</p>
                    <p class="text-xs text-gray-600">Sin C√©lula</p>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded">
                    <p class="text-2xl font-bold text-purple-600">${lcf.Recibiendo_Celula || 0}</p>
                    <p class="text-xs text-gray-600">En C√©lula</p>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded p-4">
                <h4 class="font-bold mb-2">Estado del L√≠der</h4>
                <p>Estado: <span class="status-badge ${getEstadoColor(lcf.Estado_Actividad)}">${lcf.Estado_Actividad}</span></p>
                <p class="mt-2">Carga de Trabajo: <span class="status-badge ${getCargaColor(lcf.metricas.carga_trabajo)}">${lcf.metricas.carga_trabajo}</span></p>
            </div>
            
            <div class="text-center">
                <button onclick="verSeguimientoAlmasLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg">
                    <i class="fas fa-chart-line mr-2"></i>
                    Ver Seguimiento Detallado de Almas
                </button>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}


        // Cerrar modal
function cerrarModal() {
    const modal = document.getElementById('modalLCF');
    modal.classList.add('hidden');
    // Esta l√≠nea es la correcci√≥n clave:
    modal.style.display = 'none'; 
}
        

// ==================== FUNCIONES DE TESTING ====================



        // Generar reporte PDF (Manejo Robusto V2.0)
        function generarReporteLD() {
            if (!ldSeleccionado) {
                Swal.fire('Error', 'Selecciona un LD primero', 'warning');
                return;
            }

            // Verificar si la funci√≥n parece existir en el backend (proxy)
            if (typeof google.script.run.generarReporteLD !== 'function') {
                 Swal.fire({
                    icon: 'info',
                    title: 'Funci√≥n No Implementada',
                    text: 'La funci√≥n de generaci√≥n de PDF (generarReporteLD) no est√° disponible en el backend (Code.gs).'
                });
                return;
            }
            
            Swal.fire({
                title: 'Generando reporte PDF...',
                text: 'Preparando el documento.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    Swal.close();
                    
                    if (response?.success) {
                        // Descargar el PDF
                        const link = document.createElement('a');
                        link.href = 'data:application/pdf;base64,' + response.content;
                        link.download = response.fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        Swal.fire('√âxito', 'Reporte descargado.', 'success');
                    } else {
                        mostrarError(response?.error || 'Error generando el reporte.');
                    }
                })
                .withFailureHandler(function(error) {
                    Swal.close();
                    mostrarError('Error de conexi√≥n al generar reporte: ' + error);
                })
                .generarReporteLD(ldSeleccionado);
        }
        
        
        // Imprimir detalles
        function imprimirDetalles() {
            window.print();
        }
        
        // Ver manual (Actualizado V2.0)
        function verManual() {
            Swal.fire({
                title: 'Manual de Uso V2.0',
                html: `
                    <div class="text-left space-y-4 text-sm">
                        <h4 class="font-bold text-lg">1. Actualizaci√≥n de Datos y Cach√©</h4>
                        <p>El sistema usa cach√© para cargar r√°pido. Los datos se actualizan autom√°ticamente cada 30 min. Usa el bot√≥n <strong>Actualizar</strong> para forzar la recarga inmediata desde Google Sheets (ser√° m√°s lento).</p>
                        
                        <h4 class="font-bold text-lg">2. Estados de Actividad (C√°lculo Real)</h4>
                        <p>Basado en el √∫ltimo reporte (C√©lula o Visita) registrado:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><span class="text-green-600">Activo:</span> < 7 d√≠as.</li>
                            <li><span class="text-yellow-600">Alerta:</span> 7-14 d√≠as.</li>
                            <li><span class="text-red-600">Inactivo:</span> > 30 d√≠as.</li>
                            <li><span class="text-gray-600">Sin Datos:</span> Nunca ha reportado.</li>
                        </ul>
                        
                        <h4 class="font-bold text-lg">3. M√©trica de Integraci√≥n</h4>
                        <p>Mide el porcentaje de almas (Ingresos) que han sido a√±adidas exitosamente al Directorio de C√©lulas.</p>
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'Entendido'
            });
        }
        
        // Mostrar error gen√©rico
        function mostrarError(mensaje) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: mensaje
            });
        }

        // ==================== FUNCIONES DE REPORTES PDF ====================
// INICIO DEL BLOQUE - COPIAR DESDE AQU√ç

function generarReporteLCF(idLCF, nombreLCF) {
  Swal.fire({
    title: 'Generando Reporte',
    html: `
      <div class="text-center">
        <i class="fas fa-file-pdf text-6xl text-red-500 mb-4"></i>
        <p>Preparando reporte para:</p>
        <p class="font-bold text-lg">${escapeHTML(nombreLCF)}</p>
        <p class="text-sm text-gray-500 mt-2">Esto puede tomar unos segundos...</p>
      </div>
    `,
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        // Primero descargar el archivo
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + result.content;
        link.download = result.fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Luego mostrar confirmaci√≥n
        Swal.fire({
          icon: 'success',
          title: '¬°Reporte Generado!',
          html: `
            <div class="text-left">
              <p class="mb-2"><strong>L√≠der:</strong> ${escapeHTML(result.lcf)}</p>
              <p class="mb-2"><strong>Total de almas:</strong> ${result.total_almas}</p>
              <p class="mb-2"><strong>Archivo:</strong> ${escapeHTML(result.fileName)}</p>
              
              <div class="mt-4 p-3 bg-blue-50 rounded">
                <p class="text-sm font-semibold text-blue-800">M√©tricas del reporte:</p>
                <ul class="text-sm text-gray-700 mt-2">
                  <li>‚Ä¢ En c√©lula: ${result.metricas?.en_celula || 0}</li>
                  <li>‚Ä¢ Sin c√©lula: ${result.metricas?.sin_celula || 0}</li>
                  <li>‚Ä¢ Urgentes (+30 d√≠as): ${result.metricas?.urgentes || 0}</li>
                  <li>‚Ä¢ Desean visita: ${result.metricas?.desean_visita || 0}</li>
                </ul>
              </div>
            </div>
          `,
          footer: '<p class="text-sm text-gray-500">El archivo se descarg√≥ autom√°ticamente.</p>',
          confirmButtonText: 'Cerrar',
          confirmButtonColor: '#667eea'
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error al generar reporte',
          text: result?.error || 'Ocurri√≥ un error desconocido',
          confirmButtonColor: '#ef4444'
        });
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error de conexi√≥n',
        text: 'No se pudo conectar con el servidor: ' + error.toString(),
        confirmButtonColor: '#ef4444'
      });
    })
    .generarReporteLCF(idLCF);
}



function verVistaRapidaLCF(idLCF, nombreLCF) {
  Swal.fire({
    title: 'Cargando vista r√°pida...',
    text: nombreLCF,
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });
  
  google.script.run
    .withSuccessHandler(function(result) {
      // NO cerrar Swal aqu√≠ - dejar que mostrarVistaRapidaLCF lo maneje
      if (result && result.success) {
        mostrarVistaRapidaLCF(result);
      } else {
        Swal.fire('Error', result?.error || 'Error al cargar datos', 'error');
      }
    })
    .withFailureHandler(function(error) {
      Swal.fire('Error', error.toString(), 'error');
    })
    .getVistaRapidaLCF(idLCF);
}

function mostrarVistaRapidaLCF(data) {
  // Funci√≥n auxiliar para truncar texto de forma segura (Maneja Nulos)
  const truncateText = (text, length) => {
    if (!text || text === '-') return '-';
    return text.length > length ? text.substring(0, length) + '...' : text;
  };

  const html = `
    <div class="max-h-96 overflow-y-auto">
      <table class="w-full text-xs">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="px-2 py-1 text-left">Nombre</th>
            <th class="px-2 py-1">Tel</th>
            <th class="px-2 py-1">Visita</th>
            <th class="px-2 py-1">Petici√≥n</th>
            <th class="px-2 py-1" title="Bienvenida">B</th>
            <th class="px-2 py-1" title="Visita Bendici√≥n">V</th>
            <th class="px-2 py-1" title="C√©lulas">C</th>
            <th class="px-2 py-1">Estado</th>
            <th class="px-2 py-1">D√≠as</th>
          </tr>
        </thead>
        <tbody>
          ${data.almas.length > 0 ? data.almas.map(alma => `
            <tr class="border-b hover:bg-gray-50 ${
              alma.Dias_Sin_Seguimiento > 30 ? 'bg-red-50' :
              alma.Dias_Sin_Seguimiento > 14 ? 'bg-yellow-50' : ''
            }">
              <td class="px-2 py-1 font-medium text-xs">${escapeHTML(alma.Nombre)}</td>
              <td class="px-2 py-1 text-xs">${escapeHTML(truncateText(alma.Telefono, 10))}</td>
              <td class="px-2 py-1 text-center">${alma.Acepta_Visita === 'SI' ? '‚úì' : '-'}</td>
              
              <td class="px-2 py-1 text-xs truncate max-w-[100px]" title="${escapeHTML(alma.Peticion)}">${escapeHTML(truncateText(alma.Peticion, 20))}</td>
              
              <td class="px-2 py-1 text-center ${alma.Bienvenida === '‚úì' ? 'text-green-600' : 'text-red-600'}">${alma.Bienvenida}</td>
              <td class="px-2 py-1 text-center ${alma.Visita === '‚úì' ? 'text-green-600' : 'text-red-600'}">${alma.Visita}</td>
              <td class="px-2 py-1 text-center text-xs">${alma.Celulas}</td>
              <td class="px-2 py-1">
                <span class="text-xs px-1 rounded ${
                  alma.Estado === 'Activo' ? 'bg-green-100 text-green-700' :
                  alma.Estado === 'Completado' ? 'bg-blue-100 text-blue-700' :
                  alma.Estado === 'Inactivo' ? 'bg-red-100 text-red-700' :
                  alma.Estado === 'En Riesgo' ? 'bg-orange-100 text-orange-700' :
                  'bg-gray-100 text-gray-700'
                }">${alma.Estado}</span>
              </td>
              <td class="px-2 py-1 text-center ${
                alma.Dias_Sin_Seguimiento > 30 ? 'text-red-600 font-bold' :
                alma.Dias_Sin_Seguimiento > 14 ? 'text-orange-600' :
                'text-gray-600'
              }">${alma.Dias_Sin_Seguimiento !== null ? alma.Dias_Sin_Seguimiento : '-'}</td>
            </tr>
          `).join('') : '<tr><td colspan="9" class="text-center py-4 text-gray-500">No hay almas asignadas</td></tr>'}
        </tbody>
      </table>
    </div>
    <div class="mt-4 text-xs text-gray-600">
      <p><strong>Leyenda:</strong> B=Bienvenida, V=Visita Bendici√≥n, C=C√©lulas (completados/total)</p>
    </div>
  `;
  
  Swal.fire({
    title: `Vista R√°pida: ${escapeHTML(data.lcf)}`, // Sanitizaci√≥n Aplicada
    html: html,
    width: '900px',
    confirmButtonText: 'Cerrar',
    confirmButtonColor: '#667eea'
  });
}
/**
 * Muestra el seguimiento completo de almas de un LCF
 * (Versi√≥n corregida con manejo de respuesta nula)
 */
function verSeguimientoAlmasLCF(idLCF, nombreLCF) {
  Swal.fire({
    title: 'Cargando Seguimiento',
    html: `
      <div class="text-center">
        <i class="fas fa-users fa-spin text-6xl text-blue-500 mb-4"></i>
        <p>Obteniendo datos de seguimiento para:</p>
        <p class="font-bold text-lg">${escapeHTML(nombreLCF)}</p>
        <p class="text-sm text-gray-500 mt-2">Integrando m√∫ltiples fuentes de datos...</p>
      </div>
    `,
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });
  
  google.script.run
    .withSuccessHandler(function(result) {
      Swal.close();

      // ===== INICIO DE LA CORRECCI√ìN DEFINITIVA =====

      // 1. Se verifica primero si la respuesta es nula (causado por timeout del servidor)
      if (!result) {
        Swal.fire({
          icon: 'error',
          title: 'Error de Comunicaci√≥n',
          text: 'El servidor no devolvi√≥ una respuesta. Esto usualmente ocurre porque la operaci√≥n tard√≥ demasiado (timeout).',
          confirmButtonColor: '#ef4444'
        });
        return; // Se detiene la ejecuci√≥n para evitar el error
      }
      
      // 2. Si la respuesta NO es nula, se procesa de forma segura como antes
      if (result.success) {
        mostrarModalSeguimiento(result);
      } else {
        // El backend report√≥ un error de forma controlada
        Swal.fire({
          icon: 'error',
          title: 'Error Reportado por el Servidor',
          text: result.error || 'No se pudo cargar el seguimiento',
          confirmButtonColor: '#ef4444'
        });
      }
      // ===== FIN DE LA CORRECCI√ìN DEFINITIVA =====
    })
    .withFailureHandler(function(error) {
      console.error('Error de conexi√≥n:', error);
      Swal.close();
      Swal.fire({
        icon: 'error',
        title: 'Error de Conexi√≥n',
        text: error.toString(),
        confirmButtonColor: '#ef4444'
      });
    })
    .getSeguimientoAlmasLCF(idLCF);
}

/**
¬†* Muestra el modal con el seguimiento detallado (VERSI√ìN ACTUALIZADA)
¬†*/
function mostrarModalSeguimiento(data) {
¬† if (Swal.isVisible()) {
¬† ¬† Swal.close();
¬† ¬† setTimeout(() => mostrarModalSeguimiento(data), 500);
¬† ¬† return;
¬† }
¬†¬†
¬† const modal = document.getElementById('modalLCF');
¬† const titulo = document.getElementById('modalTitulo');
¬† const contenido = document.getElementById('modalContenido');
¬†¬†
¬† if (!modal || !titulo || !contenido) {
¬† ¬† console.error('Elementos del modal no encontrados');
¬† ¬† Swal.fire('Error', 'No se pudo abrir el modal de seguimiento', 'error');
¬† ¬† return;
¬† }
¬†¬†
¬† titulo.innerHTML = `<i class="fas fa-chart-line mr-2"></i> Seguimiento de Almas - ${escapeHTML(data.lcf.Nombre)}`;
¬†¬†
¬† let html = `
¬† ¬† <div class="space-y-6">
<div>
  <h4 class="font-bold text-lg text-gray-800 mb-3">Resumen de Seguimiento</h4>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">

    <div class="bg-blue-500 text-white p-4 rounded-lg shadow-md text-center">
      <div class="text-sm">Total Almas</div>
      <div class="text-3xl font-bold">${data.resumen.total_almas}</div>
    </div>

    <div class="bg-green-500 text-white p-4 rounded-lg shadow-md text-center">
      <div class="text-sm">Con Bienvenida</div>
      <div class="text-3xl font-bold">${data.resumen.con_bienvenida}</div>
    </div>

    <div class="bg-purple-500 text-white p-4 rounded-lg shadow-md text-center">
      <div class="text-sm">Con Visita</div>
      <div class="text-3xl font-bold">${data.resumen.con_visita}</div>
    </div>

    <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md text-center">
      <div class="text-sm">En C√©lulas</div>
      <div class="text-3xl font-bold">${data.resumen.en_celulas}</div>
    </div>

  </div>
</div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="overflow-x-auto">
¬† ¬† ¬† ¬† <table class="w-full text-xs" id="tablaSeguimiento">
          ¬† ¬† ¬† ¬† ¬† <thead class="bg-gray-100 sticky top-0">
¬† ¬† ¬† ¬† ¬† ¬† <tr>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center"><input type="checkbox" onclick="seleccionarTodos(this)" title="Seleccionar Todos"></th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-left">Nombre</th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center">Tel√©fono</th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center">Acepta<br>Visita</th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center" title="Bienvenida">B</th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center" title="Visita Bendici√≥n">V</th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center" title="Progreso C√©lulas">C</th>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <th class="px-2 py-2 text-center">D√≠as</th>
¬† ¬† ¬† ¬† ¬† ¬† </tr>
¬† ¬† ¬† ¬† ¬† </thead>
¬† ¬† ¬† ¬† ¬† <tbody>
¬† ¬† ¬† ¬† ¬† ¬† ${data.almas.map((alma, index) => crearFilaSeguimiento(alma, index)).join('')}
¬† ¬† ¬† ¬† ¬† </tbody>
¬† ¬† ¬† ¬† </table>
¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="bg-gray-50 rounded p-3 text-xs">
¬† ¬† ¬† ¬† <p class="font-semibold mb-2">Leyenda de √çconos (B y V):</p>
¬† ¬† ¬† ¬† <div class="grid grid-cols-2 md:grid-cols-5 gap-x-4 gap-y-1">
¬† ¬† ¬† ¬† ¬† <span><span class="text-yellow-500 font-bold text-lg">‚≠ê</span> √âxito Clave</span>
¬† ¬† ¬† ¬† ¬† <span><span class="text-green-600 font-bold text-lg">‚úì</span> Avance Positivo</span>
¬† ¬† ¬† ¬† ¬† <span><span class="text-orange-500 font-bold text-lg">‚è≥</span> En Proceso</span>
¬† ¬† ¬† ¬† ¬† <span><span class="text-gray-500 font-bold text-lg">‚Äï</span> Contacto sin Avance</span>
¬† ¬† ¬† ¬† ¬† <span><span class="text-red-500 font-bold text-lg">‚úó</span> Pendiente</span>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="flex justify-between items-center">
¬† ¬† ¬†   <button id="btnBajaMultiple" onclick="iniciarBajaMultiple()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-2 disabled:bg-gray-400" disabled>
          <i class="fas fa-user-slash"></i> Dar de Baja
        </button>
¬† ¬† ¬† </div>
¬† ¬† </div>
¬† `;
¬†¬†
¬† contenido.innerHTML = html;
¬† modal.classList.remove('hidden');
¬† modal.style.display = 'flex';
¬† window.dataSeguimiento = data;
}

/**
 * Crea una fila de la tabla de seguimiento (VERSI√ìN FINAL Y COMPLETA)
 */
function crearFilaSeguimiento(alma, index) {
  const diasSinSeguimiento = alma.Dias_Sin_Seguimiento;
  let bgColor = (diasSinSeguimiento > 30) ? 'bg-red-50' : (diasSinSeguimiento > 14) ? 'bg-yellow-50' : '';
  const telefonoValido = alma.Telefono && alma.Telefono !== 'Sin tel√©fono' && alma.Telefono !== '-';

  // 1. Preparamos la variable (esto ya lo hiciste bien)
  const aceptaVisitaNormalizado = String(alma.Acepta_Visita || '').trim().toUpperCase();
  const esAfirmativo = (aceptaVisitaNormalizado === 'SI' || aceptaVisitaNormalizado === 'S√ç' || aceptaVisitaNormalizado === 'S');
  
  return `
    <tr class="${bgColor} hover:bg-blue-50 border-b">
      <td class="px-2 py-2 text-center">
        <input type="checkbox" class="alma-checkbox" value="${alma.ID_Alma}" onchange="actualizarEstadoBotonBaja()">
      </td>
      <td class="px-2 py-2">
        <p class="font-semibold">${escapeHTML(alma.Nombre)}</p>
      </td>
      <td class="px-2 py-2 text-center text-xs">
        ${telefonoValido ? 
          `<a href="tel:${escapeHTML(alma.Telefono)}" class="text-blue-600 hover:underline">${escapeHTML(alma.Telefono)}</a>` : 
          '<span class="text-gray-400">-</span>'
        }
      </td>
      <td class="px-2 py-2 text-center">
        <span class="${esAfirmativo ? 'text-green-600' : 'text-gray-400'}">
          ${esAfirmativo ? '‚úì S√≠' : '‚úó No'}
        </span>
      </td>
      <td class="px-2 py-2 text-center">
        <span title="${escapeHTML(alma.Bienvenida.resultado)}" class="${alma.Bienvenida.color} text-lg">
          ${alma.Bienvenida.simbolo}
        </span>
      </td>
      <td class="px-2 py-2 text-center">
        <span title="${escapeHTML(alma.Visita_Bendicion.resultado)}" class="${alma.Visita_Bendicion.color} text-lg">
          ${alma.Visita_Bendicion.simbolo}
        </span>
      </td>
      <td class="px-2 py-2 text-center">
        ${alma.Progreso_Celulas.texto}
      </td>
      <td class="px-2 py-2 text-center">
        <span class="${diasSinSeguimiento > 30 ? 'text-red-600 font-bold' : diasSinSeguimiento > 14 ? 'text-orange-600' : 'text-gray-600'}">
          ${diasSinSeguimiento !== null ? diasSinSeguimiento : '-'}
        </span>
      </td>
    </tr>
  `;
}

/**
 * Filtra la tabla de seguimiento
 */
function filtrarSeguimiento(filtro) {
  const filas = document.querySelectorAll('#tablaSeguimiento tbody tr');
  
  filas.forEach(fila => {
    let mostrar = true;
    
    switch(filtro) {
      case 'urgentes':
        mostrar = fila.dataset.prioridad === 'Urgente';
        break;
      case 'activos':
        mostrar = fila.dataset.estado === 'Activo';
        break;
      case 'sin-bienvenida':
        // Verificar si tiene ‚úó en la columna de bienvenida (Columna 5)
        const bienvenidaCell = fila.querySelector('td:nth-child(5) span');
        mostrar = bienvenidaCell && bienvenidaCell.textContent.trim() === '‚úó';
        break;
      case 'todos':
      default:
        mostrar = true;
    }
    
    fila.style.display = mostrar ? '' : 'none';
  });
}

/**
 * Ver detalle completo de un alma
 */
function verDetalleAlma(idAlma) {
  // Asegurarse de que window.dataSeguimiento exista
  if (!window.dataSeguimiento || !window.dataSeguimiento.almas) {
    console.error("Datos de seguimiento no disponibles.");
    return;
  }

  const alma = window.dataSeguimiento.almas.find(a => a.ID_Alma === idAlma);
  if (!alma) return;
  
  Swal.fire({
    title: `Detalle: ${escapeHTML(alma.Nombre)}`,
    html: `
      <div class="text-left space-y-4">
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <p class="font-semibold text-gray-600">Tel√©fono:</p>
            <p>${escapeHTML(alma.Telefono)}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-600">Estado:</p>
            <p class="font-bold ${alma.Estado === 'Activo' ? 'text-green-600' : 'text-red-600'}">${alma.Estado}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-600">Acept√≥ a Jes√∫s:</p>
            <p>${alma.Acepto_Jesus}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-600">Desea Visita:</p>
            <p>${alma.Acepta_Visita}</p>
          </div>
          <div class="col-span-2">
            <p class="font-semibold text-gray-600">Petici√≥n de Oraci√≥n:</p>
            <p class="italic">${escapeHTML(alma.Peticion)}</p>
          </div>
        </div>
        
        <div class="border-t pt-4">
          <h4 class="font-bold mb-2">Progreso de Seguimiento</h4>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>Bienvenida:</span>
              <span class="${alma.Bienvenida.completado ? 'text-green-600' : 'text-red-600'}">
                ${escapeHTML(alma.Bienvenida.resultado)}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Visita de Bendici√≥n:</span>
              <span class="${alma.Visita_Bendicion.completado ? 'text-green-600' : 'text-red-600'}">
                ${escapeHTML(alma.Visita_Bendicion.resultado)}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Progreso en C√©lulas:</span>
              <span>${alma.Progreso_Celulas.texto}</span>
            </div>
          </div>
        </div>
        
        ${alma.Progreso_Celulas.temas ? `
          <div class="border-t pt-4">
            <h4 class="font-bold mb-2">Temas Completados</h4>
            <div class="grid grid-cols-6 gap-2">
              ${Object.entries(alma.Progreso_Celulas.temas).map(([tema, completado]) => `
                <div class="text-center">
                  <span class="block ${completado ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'} rounded p-1 text-xs">
                    ${tema}
                  </span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        <div class="border-t pt-4">
          <p class="text-sm text-gray-600">
            <i class="fas fa-calendar-alt mr-2"></i>
            D√≠as sin seguimiento: <strong>${alma.Dias_Sin_Seguimiento || 'N/A'}</strong>
          </p>
          <p class="text-sm text-gray-600">
            <i class="fas fa-flag mr-2"></i>
            Prioridad: <strong class="${alma.Prioridad === 'Urgente' ? 'text-red-600' : ''}">${alma.Prioridad}</strong>
          </p>
        </div>
      </div>
    `,
    width: '600px',
    confirmButtonText: 'Cerrar'
  });
}

// ==================== ACTUALIZAR TARJETAS DE LCF ====================

/**
 * Actualizar las tarjetas de LCF para incluir bot√≥n de seguimiento
 */
function actualizarTarjetaLCFConSeguimiento(lcf) {
  // Esta funci√≥n parece no estar en uso activo en el flujo principal, pero la mantenemos
  // Usamos escapeHTML para el nombre del LCF
  return `
    <button onclick="verSeguimientoAlmasLCF('${lcf.ID_Lider}', '${escapeAttr(lcf.Nombre_Lider)}')"
            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs transition"
            title="Ver seguimiento de almas">
      <i class="fas fa-chart-line"></i> Seguimiento
    </button>
  `;
}

/**
 * Controla el estado del bot√≥n de baja m√∫ltiple.
 * Se activa/desactiva si hay al menos un checkbox marcado.
 */
function actualizarEstadoBotonBaja() {
  const checkboxes = document.querySelectorAll('.alma-checkbox:checked');
  const boton = document.getElementById('btnBajaMultiple');
  if (boton) {
    boton.disabled = checkboxes.length === 0;
  }
}

/**
 * L√≥gica para el checkbox "Seleccionar Todos".
 */
function seleccionarTodos(source) {
  const checkboxes = document.querySelectorAll('.alma-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = source.checked;
  });
  actualizarEstadoBotonBaja();
}

/**
 * Inicia el proceso de baja m√∫ltiple, con actualizaci√≥n visual al finalizar.
 */
function iniciarBajaMultiple() {
  const checkboxes = document.querySelectorAll('.alma-checkbox:checked');
  const idsParaBaja = Array.from(checkboxes).map(cb => cb.value);

  if (idsParaBaja.length === 0) {
    Swal.fire('Atenci√≥n', 'Debes seleccionar al menos un alma para dar de baja.', 'warning');
    return;
  }

  Swal.fire({
    title: `¬øDar de baja a ${idsParaBaja.length} almas?`,
    text: "Esta acci√≥n marcar√° los registros como inactivos.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'S√≠, dar de baja',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            Swal.fire('¬°√âxito!', response.message, 'success');
            
            // ===== INICIO DE LA MODIFICACI√ìN =====
            // Bucle para eliminar cada fila de la tabla visualmente
            idsParaBaja.forEach(id => {
              const checkbox = document.querySelector(`.alma-checkbox[value="${id}"]`);
              if (checkbox) {
                // Sube en el DOM hasta encontrar la fila (tr) y la elimina
                checkbox.closest('tr').remove();
              }
            });
            // Al eliminar las filas, tambi√©n reseteamos el bot√≥n
            actualizarEstadoBotonBaja();
            // ===== FIN DE LA MODIFICACI√ìN =====

          } else {
            Swal.fire('Error', response.error, 'error');
          }
        })
        .withFailureHandler(error => Swal.fire('Error de Conexi√≥n', error.toString(), 'error'))
        .darDeBajaAlmasEnLote(idsParaBaja);
    }
  });
}

// ==================== FUNCIONES DE EXPORTACI√ìN ====================

/**
 * Genera un reporte PDF con el seguimiento
 */
function generarReporteSeguimientoPDF(idLCF, nombreLCF) {
  // Reutilizar la funci√≥n existente pero con datos de seguimiento
  generarReporteLCF(idLCF, nombreLCF);
}

/**
 * Exporta el seguimiento a Excel (placeholder)
 */
function exportarSeguimientoExcel(idLCF) {
  Swal.fire({
    icon: 'info',
    title: 'Funci√≥n en desarrollo',
    text: 'La exportaci√≥n a Excel estar√° disponible pr√≥ximamente',
    confirmButtonText: 'Entendido'
  });
}
</script>

<style>
  * { font-family: 'Inter', sans-serif; }
    
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    /* ‚úÖ NUEVO: Estilos para perfiles de l√≠deres basados en IDP */
    .status-estratega { background: #10b981; color: #ffffff; font-weight: 600; } /* üöÄ Verde oscuro */
    .status-conector { background: #86efac; color: #065f46; font-weight: 600; } /* üéØ Verde claro */
    .status-activador { background: #fef3c7; color: #92400e; font-weight: 600; } /* ‚ö° Amarillo */
    .status-desarrollo { background: #e5e7eb; color: #6b7280; font-weight: 600; } /* üå± Gris */
    
    /* Compatibilidad con c√≥digo antiguo */
    .status-activo { background: #10b981; color: #ffffff; }
    .status-alerta { background: #fef3c7; color: #92400e; }
    .status-inactivo { background: #e5e7eb; color: #6b7280; }
    .status-sindatos { background: #e5e7eb; color: #6b7280; }

    .carga-optima { background: #d1fae5; color: #065f46; }
    .carga-moderada { background: #dbeafe; color: #1e40af; }
    .carga-alta { background: #fed7aa; color: #92400e; }
    .carga-sobrecargado { background: #fee2e2; color: #991b1b; }
    
    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* ---- INICIO DE LAS REGLAS DE IMPRESI√ìN ---- */
    @media print {
        /* Oculta todo lo que no queremos imprimir */
        body > *:not(#modalLCF) {
            display: none !important;
        }

        /* Asegura que el modal y su contenido sean visibles */
        #modalLCF, #modalLCF > div {
            display: block !important;
            position: static !important;
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
            background: none !important;
        }

        #modalContenido {
            padding: 0 !important;
            max-height: none !important;
            overflow: visible !important;
            border: none !important;
        }

        /* Oculta botones y otros elementos no necesarios */
        .no-print, header, #loader, #accionesLD, #ldSelector, .swal2-container {
            display: none !important;
        }
        
        /* Estilos generales para el documento impreso */
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            color: #000;
        }

        h1, h2, h3, h4, p {
            color: #000 !important;
        }

        /* Forzar que las cuadr√≠culas (grids) se mantengan en la impresi√≥n */
        .grid {
            display: grid !important;
        }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
        .gap-4 { gap: 1rem !important; }

        /* Estilos para la tabla en la impresi√≥n */
        table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ccc !important;
            padding: 4px 6px !important;
            text-align: left !important;
        }
        thead {
            background-color: #eee !important;
        }

        /* Prevenir que los elementos se corten entre p√°ginas */
        tr, h3, h4 {
            page-break-inside: avoid;
        }
    }
    /* ---- FIN DE LAS REGLAS DE IMPRESI√ìN ---- */
</style>

</body>
</html>