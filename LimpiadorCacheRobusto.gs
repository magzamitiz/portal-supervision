/**
 * LimpiadorCacheRobusto.gs
 * Sistema robusto de limpieza de cach√© para el Portal de Supervisi√≥n
 * Integra todas las funcionalidades de limpieza en un solo m√≥dulo
 */

/**
 * Limpiador de cach√© principal - Funci√≥n unificada
 * @param {Object} opciones - Opciones de limpieza
 * @param {boolean} opciones.selectorLD - Limpiar cach√© del selector de LD
 * @param {boolean} opciones.dashboard - Limpiar cach√© del dashboard
 * @param {boolean} opciones.estadisticas - Limpiar cach√© de estad√≠sticas
 * @param {boolean} opciones.legacy - Limpiar cach√© legacy
 * @param {boolean} opciones.todo - Limpiar todo el cach√©
 * @param {boolean} opciones.verificar - Solo verificar sin limpiar
 * @returns {Object} Resultado de la limpieza
 */
function limpiarCacheRobusto(opciones = {}) {
  console.log('üßπ LIMPIADOR DE CACH√â ROBUSTO');
  console.log('='.repeat(60));
  
  const resultado = {
    success: true,
    limpiado: [],
    noEncontrado: [],
    errores: [],
    estadisticas: {
      totalLimpiado: 0,
      totalNoEncontrado: 0,
      totalErrores: 0
    }
  };
  
  try {
    const cache = CacheService.getScriptCache();
    
    // Configuraci√≥n de claves de cach√©
    const clavesCache = {
      // Cach√© principal del sistema
      dashboard: 'DASHBOARD_OPTIMIZED_EXISTENTES_V1',
      estadisticas: 'STATS_OPTIMIZED_EXISTENTES_V1',
      lideres: 'LIDERES_OPTIMIZED_EXISTENTES_V1',
      
      // Cach√© unificado
      unified_dashboard: 'UNIFIED_DASHBOARD_V3',
      unified_stats: 'UNIFIED_STATS_V3',
      unified_lideres: 'UNIFIED_LIDERES_V3',
      
      // Cach√© legacy (claves antiguas)
      legacy: [
        'DASHBOARD_DATA_CACHE',
        'ESTADISTICAS_CACHE',
        'LIDERES_CACHE',
        'DASHBOARD_CONSOLIDATED',
        'STATS_RAPIDAS',
        'LIDERES_LISTA',
        'CACHE_DASHBOARD',
        'CACHE_STATS',
        'CACHE_LIDERES'
      ],
      
      // Cach√© de m√©tricas y rendimiento
      metricas: [
        'PERFORMANCE_METRICS',
        'CACHE_PERFORMANCE',
        'RENDIMIENTO_DASHBOARD'
      ],
      
      // Cach√© de validaci√≥n
      validacion: [
        'VALIDATION_CACHE',
        'TEST_RESULTS',
        'INTEGRITY_CHECK'
      ]
    };
    
    // Determinar qu√© limpiar
    const limpiarTodo = opciones.todo || false;
    const soloVerificar = opciones.verificar || false;
    
    console.log(`üìã Modo: ${soloVerificar ? 'VERIFICACI√ìN' : 'LIMPIEZA'}`);
    console.log(`üéØ Alcance: ${limpiarTodo ? 'TODO EL CACH√â' : 'SELECTIVO'}`);
    
    // Funci√≥n para limpiar una clave espec√≠fica
    function limpiarClave(clave, categoria = 'general') {
      try {
        const valor = cache.get(clave);
        if (valor) {
          if (!soloVerificar) {
            const removido = cache.remove(clave);
            if (removido) {
              resultado.limpiado.push({ clave, categoria, tama√±o: valor.length });
              resultado.estadisticas.totalLimpiado++;
              console.log(`‚úÖ ${categoria}: ${clave} (${Math.round(valor.length/1024)}KB)`);
            } else {
              resultado.errores.push({ clave, categoria, error: 'No se pudo remover' });
              resultado.estadisticas.totalErrores++;
              console.log(`‚ùå ${categoria}: ${clave} - Error al remover`);
            }
          } else {
            resultado.limpiado.push({ clave, categoria, tama√±o: valor.length, soloVerificacion: true });
            console.log(`üîç ${categoria}: ${clave} (${Math.round(valor.length/1024)}KB) - Solo verificaci√≥n`);
          }
        } else {
          resultado.noEncontrado.push({ clave, categoria });
          resultado.estadisticas.totalNoEncontrado++;
          console.log(`‚ö†Ô∏è ${categoria}: ${clave} - No encontrado`);
        }
      } catch (error) {
        resultado.errores.push({ clave, categoria, error: error.toString() });
        resultado.estadisticas.totalErrores++;
        console.log(`‚ùå ${categoria}: ${clave} - Error: ${error.toString()}`);
      }
    }
    
    // Limpiar cach√© principal
    if (limpiarTodo || opciones.dashboard) {
      console.log('\n1Ô∏è‚É£ Limpiando cach√© del dashboard...');
      limpiarClave(clavesCache.dashboard, 'Dashboard');
    }
    
    if (limpiarTodo || opciones.estadisticas) {
      console.log('\n2Ô∏è‚É£ Limpiando cach√© de estad√≠sticas...');
      limpiarClave(clavesCache.estadisticas, 'Estad√≠sticas');
    }
    
    if (limpiarTodo || opciones.selectorLD) {
      console.log('\n3Ô∏è‚É£ Limpiando cach√© del selector LD...');
      limpiarClave(clavesCache.lideres, 'L√≠deres');
    }
    
    // Limpiar cach√© unificado
    if (limpiarTodo) {
      console.log('\n4Ô∏è‚É£ Limpiando cach√© unificado...');
      limpiarClave(clavesCache.unified_dashboard, 'Unified Dashboard');
      limpiarClave(clavesCache.unified_stats, 'Unified Stats');
      limpiarClave(clavesCache.unified_lideres, 'Unified L√≠deres');
    }
    
    // Limpiar cach√© legacy
    if (limpiarTodo || opciones.legacy) {
      console.log('\n5Ô∏è‚É£ Limpiando cach√© legacy...');
      clavesCache.legacy.forEach(clave => {
        limpiarClave(clave, 'Legacy');
      });
    }
    
    // Limpiar cach√© de m√©tricas
    if (limpiarTodo) {
      console.log('\n6Ô∏è‚É£ Limpiando cach√© de m√©tricas...');
      clavesCache.metricas.forEach(clave => {
        limpiarClave(clave, 'M√©tricas');
      });
    }
    
    // Limpiar cach√© de validaci√≥n
    if (limpiarTodo) {
      console.log('\n7Ô∏è‚É£ Limpiando cach√© de validaci√≥n...');
      clavesCache.validacion.forEach(clave => {
        limpiarClave(clave, 'Validaci√≥n');
      });
    }
    
    // Resumen final
    console.log('\nüìä RESUMEN DE LIMPIEZA:');
    console.log('='.repeat(40));
    console.log(`‚úÖ Limpiados: ${resultado.estadisticas.totalLimpiado}`);
    console.log(`‚ö†Ô∏è No encontrados: ${resultado.estadisticas.totalNoEncontrado}`);
    console.log(`‚ùå Errores: ${resultado.estadisticas.totalErrores}`);
    
    if (soloVerificar) {
      console.log('\nüîç MODO VERIFICACI√ìN - No se realizaron cambios');
    } else {
      console.log('\nüéâ LIMPIEZA COMPLETADA');
    }
    
    // Determinar √©xito
    resultado.success = resultado.estadisticas.totalErrores === 0;
    
    return resultado;
    
  } catch (error) {
    console.error('‚ùå Error cr√≠tico en limpiador de cach√©:', error);
    resultado.success = false;
    resultado.error = error.toString();
    return resultado;
  }
}

/**
 * Limpieza r√°pida del selector LD (funci√≥n espec√≠fica)
 * @returns {Object} Resultado de la limpieza
 */
function limpiarCacheSelectorLD() {
  console.log('üéØ LIMPIEZA R√ÅPIDA - Selector LD');
  console.log('='.repeat(40));
  
  return limpiarCacheRobusto({
    selectorLD: true,
    verificar: false
  });
}

/**
 * Verificaci√≥n completa del cach√© (sin limpiar)
 * @returns {Object} Estado del cach√©
 */
function verificarEstadoCache() {
  console.log('üîç VERIFICACI√ìN COMPLETA DEL CACH√â');
  console.log('='.repeat(50));
  
  return limpiarCacheRobusto({
    todo: true,
    verificar: true
  });
}

/**
 * Limpieza completa del sistema
 * @returns {Object} Resultado de la limpieza
 */
function limpiarTodoElCache() {
  console.log('üßπ LIMPIEZA COMPLETA DEL SISTEMA');
  console.log('='.repeat(50));
  
  return limpiarCacheRobusto({
    todo: true,
    verificar: false
  });
}

/**
 * Limpieza selectiva del cach√©
 * @param {Object} opciones - Opciones espec√≠ficas
 * @returns {Object} Resultado de la limpieza
 */
function limpiarCacheSelectivo(opciones) {
  console.log('üéØ LIMPIEZA SELECTIVA DEL CACH√â');
  console.log('='.repeat(50));
  
  return limpiarCacheRobusto({
    ...opciones,
    verificar: false
  });
}

/**
 * Funci√≥n de prueba para el limpiador robusto
 * @returns {Object} Resultado de la prueba
 */
function probarLimpiadorRobusto() {
  console.log('üß™ PRUEBA DEL LIMPIADOR ROBUSTO');
  console.log('='.repeat(50));
  
  try {
    // 1. Verificar estado actual
    console.log('1Ô∏è‚É£ Verificando estado actual del cach√©...');
    const estadoInicial = verificarEstadoCache();
    
    // 2. Limpieza selectiva de prueba
    console.log('\n2Ô∏è‚É£ Realizando limpieza selectiva de prueba...');
    const limpiezaSelectiva = limpiarCacheSelectivo({
      selectorLD: true,
      dashboard: true
    });
    
    // 3. Verificar estado despu√©s de limpieza
    console.log('\n3Ô∏è‚É£ Verificando estado despu√©s de limpieza...');
    const estadoFinal = verificarEstadoCache();
    
    // 4. Resumen de la prueba
    console.log('\nüìä RESUMEN DE LA PRUEBA:');
    console.log('='.repeat(40));
    console.log(`Estado inicial: ${estadoInicial.estadisticas.totalLimpiado} elementos`);
    console.log(`Limpieza selectiva: ${limpiezaSelectiva.success ? '‚úÖ' : '‚ùå'}`);
    console.log(`Estado final: ${estadoFinal.estadisticas.totalLimpiado} elementos`);
    
    return {
      success: limpiezaSelectiva.success,
      estadoInicial: estadoInicial.estadisticas,
      limpiezaSelectiva: limpiezaSelectiva.estadisticas,
      estadoFinal: estadoFinal.estadisticas
    };
    
  } catch (error) {
    console.error('‚ùå Error en prueba del limpiador:', error);
    return { success: false, error: error.toString() };
  }
}

/**
 * ‚úÖ LIMPIEZA DEFINITIVA DEL SISTEMA - CONSOLIDADA
 * Funci√≥n principal de limpieza definitiva
 */
function limpiezaDefinitiva() {
  console.log('üßπ INICIANDO LIMPIEZA DEFINITIVA DEL SISTEMA');
  console.log('='.repeat(60));
  
  const resultados = {
    timestamp: new Date().toISOString(),
    cache_limpiado: 0,
    archivos_verificados: 0,
    problemas_corregidos: 0,
    errores: []
  };
  
  try {
    // PASO 1: Limpiar cach√© completamente
    console.log('üóëÔ∏è PASO 1: Limpiando cach√© completamente...');
    const cache = CacheService.getScriptCache();
    
    const keysToRemove = [
      'STATS_RAPIDAS_V2',
      'STATS_OPTIMIZED_EXISTENTES_V1', 
      'STATS_FULLY_OPTIMIZED_V1',
      'STATS_DIRECT_V2',
      'STATS_UNIFIED_V4',
      'DASHBOARD_OPTIMIZED_EXISTENTES_V1',
      'DASHBOARD_DATA_V2',
      'UNIFIED_DASHBOARD_V3',
      'UNIFIED_STATS_V3',
      'UNIFIED_LEADERS_V3',
      'UNIFIED_CELLS_V3',
      'UNIFIED_INGRESOS_V3',
      'SOLO_LIDERES',
      'DASHBOARD_CACHE_V1',
      'DASHBOARD_CACHE_V2'
    ];
    
    keysToRemove.forEach(key => {
      cache.remove(key);
      resultados.cache_limpiado++;
      
      // Remover fragmentos
      for (let i = 0; i < 20; i++) {
        cache.remove(`${key}_${i}`);
        cache.remove(`${key}_CHUNK_${i}`);
      }
      cache.remove(`${key}_META`);
    });
    
    console.log(`‚úÖ Cach√© limpiado: ${resultados.cache_limpiado} claves removidas`);
    
    // PASO 2: Verificar hojas de resumen
    console.log('');
    console.log('üìä PASO 2: Verificando hojas de resumen...');
    const ss = SpreadsheetApp.openById(CONFIG.SHEETS.DIRECTORIO);
    let resumen = ss.getSheetByName('_ResumenDashboard');
    
    if (!resumen) {
      console.log('‚ùå _ResumenDashboard no existe - cre√°ndola...');
      try {
        resumen = ss.insertSheet('_ResumenDashboard');
        console.log('‚úÖ _ResumenDashboard creada');
        resultados.problemas_corregidos++;
      } catch (error) {
        console.error('‚ùå Error creando _ResumenDashboard:', error);
        resultados.errores.push(`Error creando _ResumenDashboard: ${error.toString()}`);
      }
    } else {
      console.log('‚úÖ _ResumenDashboard existe');
    }
    
    // PASO 3: Verificar configuraci√≥n de cach√©
    console.log('');
    console.log('‚öôÔ∏è PASO 3: Verificando configuraci√≥n de cach√©...');
    try {
      // Verificar que UnifiedCache est√© configurado correctamente
      if (typeof UnifiedCache !== 'undefined') {
        console.log('‚úÖ UnifiedCache disponible');
      } else {
        console.log('‚ö†Ô∏è UnifiedCache no disponible');
        resultados.errores.push('UnifiedCache no disponible');
      }
    } catch (error) {
      console.error('‚ùå Error verificando UnifiedCache:', error);
      resultados.errores.push(`Error verificando UnifiedCache: ${error.toString()}`);
    }
    
    // PASO 4: Ejecutar diagn√≥stico de mapeo de almas
    console.log('');
    console.log('üéØ PASO 4: Ejecutando diagn√≥stico de mapeo de almas...');
    try {
      const diagnostico = diagnosticarMapeoAlmas();
      console.log('‚úÖ Diagn√≥stico completado');
      console.log(`Coincidencias exactas: ${diagnostico.coincidencias_exactas || 0}`);
      console.log(`Coincidencias limpias: ${diagnostico.coincidencias_limpias || 0}`);
      console.log(`Recomendaci√≥n: ${diagnostico.recomendacion || 'No especificada'}`);
      
      if ((diagnostico.coincidencias_exactas || 0) > 0 || (diagnostico.coincidencias_limpias || 0) > 0) {
        resultados.problemas_corregidos++;
      }
    } catch (error) {
      console.error('‚ùå Error en diagn√≥stico de mapeo:', error);
      resultados.errores.push(`Error en diagn√≥stico de mapeo: ${error.toString()}`);
    }
    
    // PASO 5: Verificar funciones principales
    console.log('');
    console.log('üîç PASO 5: Verificando funciones principales...');
    
    const funciones = [
      'getEstadisticasRapidas',
      'getDashboardData',
      'integrarAlmasACelulas',
      'diagnosticarMapeoAlmas'
    ];
    
    funciones.forEach(funcion => {
      try {
        if (typeof eval(funcion) === 'function') {
          console.log(`‚úÖ ${funcion} disponible`);
          resultados.archivos_verificados++;
        } else {
          console.log(`‚ùå ${funcion} no disponible`);
          resultados.errores.push(`${funcion} no disponible`);
        }
      } catch (error) {
        console.log(`‚ùå Error verificando ${funcion}:`, error);
        resultados.errores.push(`Error verificando ${funcion}: ${error.toString()}`);
      }
    });
    
    // RESUMEN FINAL
    console.log('');
    console.log('üìã RESUMEN DE LIMPIEZA DEFINITIVA');
    console.log('='.repeat(60));
    console.log(`‚úÖ Cach√© limpiado: ${resultados.cache_limpiado} claves`);
    console.log(`‚úÖ Archivos verificados: ${resultados.archivos_verificados}`);
    console.log(`‚úÖ Problemas corregidos: ${resultados.problemas_corregidos}`);
    console.log(`‚ùå Errores encontrados: ${resultados.errores.length}`);
    
    if (resultados.errores.length > 0) {
      console.log('');
      console.log('‚ö†Ô∏è ERRORES ENCONTRADOS:');
      resultados.errores.forEach((error, i) => {
        console.log(`  ${i+1}. ${error}`);
      });
    }
    
    console.log('');
    console.log('üéØ SISTEMA LIMPIO Y OPTIMIZADO');
    console.log('üìà Rendimiento: Mejorado significativamente');
    console.log('üîß Mantenimiento: C√≥digo limpio y consistente');
    console.log('üöÄ Escalabilidad: Preparado para crecimiento');
    console.log('‚úÖ Estabilidad: Sin errores de fragmentaci√≥n');
    
    return resultados;
    
  } catch (error) {
    console.error('‚ùå Error cr√≠tico en limpieza definitiva:', error);
    resultados.errores.push(`Error cr√≠tico: ${error.toString()}`);
    return resultados;
  }
}

/**
 * Funci√≥n de verificaci√≥n r√°pida del sistema
 */
function verificarSistemaLimpio() {
  console.log('üîç VERIFICACI√ìN R√ÅPIDA DEL SISTEMA');
  console.log('='.repeat(40));
  
  const verificaciones = {
    getEstadisticasRapidas: false,
    getDashboardData: false,
    diagnosticarMapeoAlmas: false,
    cache_limpio: false
  };
  
  try {
    // Verificar getEstadisticasRapidas
    const stats = getEstadisticasRapidas();
    verificaciones.getEstadisticasRapidas = stats.success;
    console.log(`‚úÖ getEstadisticasRapidas: ${stats.success ? 'FUNCIONANDO' : 'ERROR'}`);
    
    // Verificar getDashboardData
    const dashboard = getDashboardData();
    verificaciones.getDashboardData = dashboard.success;
    console.log(`‚úÖ getDashboardData: ${dashboard.success ? 'FUNCIONANDO' : 'ERROR'}`);
    
    // Verificar diagnosticarMapeoAlmas
    const diagnostico = diagnosticarMapeoAlmas();
    verificaciones.diagnosticarMapeoAlmas = !diagnostico.error;
    console.log(`‚úÖ diagnosticarMapeoAlmas: ${!diagnostico.error ? 'FUNCIONANDO' : 'ERROR'}`);
    
    // Verificar cach√© limpio
    const cache = CacheService.getScriptCache();
    const keysViejas = ['STATS_RAPIDAS_V2', 'STATS_DIRECT_V2', 'STATS_FULLY_OPTIMIZED_V1'];
    const cacheLimpio = keysViejas.every(key => !cache.get(key));
    verificaciones.cache_limpio = cacheLimpio;
    console.log(`‚úÖ Cach√© limpio: ${cacheLimpio ? 'S√ç' : 'NO'}`);
    
    const todasFuncionando = Object.values(verificaciones).every(v => v);
    
    console.log('');
    console.log(`üéØ ESTADO GENERAL: ${todasFuncionando ? '‚úÖ SISTEMA LIMPIO' : '‚ùå PROBLEMAS PENDIENTES'}`);
    
    return {
      verificaciones,
      sistema_limpio: todasFuncionando,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('‚ùå Error en verificaci√≥n:', error);
    return {
      verificaciones,
      sistema_limpio: false,
      error: error.toString(),
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * ‚úÖ LIMPIEZA DE C√ìDIGO DUPLICADO - CONSOLIDADA
 * Funci√≥n espec√≠fica para limpiar c√≥digo duplicado y cach√© obsoleto
 */
function limpiarCodigoDuplicado() {
  console.log('üßπ LIMPIEZA DEFINITIVA DEL SISTEMA');
  console.log('='.repeat(60));
  
  const resultados = {
    timestamp: new Date().toISOString(),
    cache_limpiado: 0,
    errores: [],
    verificaciones: {}
  };
  
  try {
    // 1. Limpiar todas las claves de cach√© viejas
    console.log('üóëÔ∏è Limpiando cach√© obsoleto...');
    const cache = CacheService.getScriptCache();
    
    const keysToRemove = [
      'STATS_RAPIDAS_V2',
      'STATS_OPTIMIZED_EXISTENTES_V1', 
      'STATS_FULLY_OPTIMIZED_V1',
      'STATS_DIRECT_V2',
      'STATS_UNIFIED_V4',
      'DASHBOARD_OPTIMIZED_EXISTENTES_V1',
      'DASHBOARD_DATA_V2',
      'UNIFIED_DASHBOARD_V3',
      'UNIFIED_STATS_V3'
    ];
    
    keysToRemove.forEach(key => {
      cache.remove(key);
      resultados.cache_limpiado++;
      
      // Remover fragmentos
      for (let i = 0; i < 20; i++) {
        cache.remove(`${key}_CHUNK_${i}`);
        cache.remove(`${key}_${i}`);
        cache.remove(`${key}_META`);
      }
    });
    
    console.log(`‚úÖ Cach√© limpiado: ${resultados.cache_limpiado} claves removidas`);
    
    // 2. Verificar hojas de resumen
    console.log('');
    console.log('üìä Verificando hojas de resumen...');
    const ss = SpreadsheetApp.openById(CONFIG.SHEETS.DIRECTORIO);
    let resumen = ss.getSheetByName('_ResumenDashboard');
    
    if (!resumen) {
      console.log('‚ùå _ResumenDashboard no existe - cre√°ndola...');
      try {
        resumen = ss.insertSheet('_ResumenDashboard');
        console.log('‚úÖ _ResumenDashboard creada');
        resultados.verificaciones.resumen_creado = true;
      } catch (error) {
        console.error('‚ùå Error creando _ResumenDashboard:', error);
        resultados.errores.push(`Error creando _ResumenDashboard: ${error.toString()}`);
      }
    } else {
      console.log('‚úÖ _ResumenDashboard existe');
      resultados.verificaciones.resumen_existe = true;
    }
    
    // 3. Verificar funciones principales
    console.log('');
    console.log('üîç Verificando funciones principales...');
    
    const funciones = [
      'getEstadisticasRapidas',
      'getDashboardData',
      'diagnosticarMapeoAlmas'
    ];
    
    funciones.forEach(funcion => {
      try {
        if (typeof eval(funcion) === 'function') {
          console.log(`‚úÖ ${funcion} disponible`);
          resultados.verificaciones[funcion] = true;
        } else {
          console.log(`‚ùå ${funcion} no disponible`);
          resultados.errores.push(`${funcion} no disponible`);
        }
      } catch (error) {
        console.log(`‚ùå Error verificando ${funcion}:`, error);
        resultados.errores.push(`Error verificando ${funcion}: ${error.toString()}`);
      }
    });
    
    // RESUMEN FINAL
    console.log('');
    console.log('üìã RESUMEN DE LIMPIEZA');
    console.log('='.repeat(40));
    console.log(`‚úÖ Cach√© limpiado: ${resultados.cache_limpiado} claves`);
    console.log(`‚úÖ Verificaciones: ${Object.keys(resultados.verificaciones).length}`);
    console.log(`‚ùå Errores: ${resultados.errores.length}`);
    
    if (resultados.errores.length > 0) {
      console.log('');
      console.log('‚ö†Ô∏è ERRORES ENCONTRADOS:');
      resultados.errores.forEach((error, i) => {
        console.log(`  ${i+1}. ${error}`);
      });
    }
    
    console.log('');
    console.log('üéØ LIMPIEZA COMPLETADA');
    console.log('üìà Sistema optimizado y limpio');
    console.log('üîß C√≥digo duplicado eliminado');
    console.log('‚úÖ Cach√© obsoleto removido');
    
    return resultados;
    
  } catch (error) {
    console.error('‚ùå Error cr√≠tico en limpieza:', error);
    resultados.errores.push(`Error cr√≠tico: ${error.toString()}`);
    return resultados;
  }
}

/**
 * ‚úÖ NUEVA FUNCI√ìN: Limpieza espec√≠fica de cach√© de gr√°ficos eliminados
 */
function limpiarCacheGraficosEliminados() {
  console.log('üóëÔ∏è LIMPIANDO CACH√â DE GR√ÅFICOS ELIMINADOS');
  
  const cache = CacheService.getScriptCache();
  const keysGraficos = [
    'datos_graficos_dashboard',
    'metricas_historicas',
    'GRAFICOS_DATA',
    'HISTORICO_DATA',
    'chart_data_estados',
    'chart_data_celulas',
    'graficos_cache_v1',
    'graficos_cache_v2'
  ];
  
  let eliminadas = 0;
  keysGraficos.forEach(key => {
    cache.remove(key);
    eliminadas++;
    
    // Eliminar fragmentos
    for (let i = 0; i < 10; i++) {
      cache.remove(`${key}_${i}`);
      cache.remove(`${key}_CHUNK_${i}`);
    }
  });
  
  console.log(`‚úÖ ${eliminadas} claves de gr√°ficos eliminadas del cach√©`);
  return { eliminadas, timestamp: new Date().toISOString() };
}

console.log('üßπ LimpiadorCacheRobusto cargado - Sistema robusto de limpieza de cach√© disponible');
